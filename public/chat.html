<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta 
    name="viewport" 
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" 
  />
  <title>–ß–∞—Ç</title>
  <link rel="stylesheet" href="css/style.css" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <header>
    <span id="backBtn">&#8592;</span>
    <div>
      <div id="chatTitle">–ß–∞—Ç</div>
      <div id="status">–æ—Ñ–ª–∞–π–Ω</div>
    </div>
  </header>

  <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä, –≥–¥–µ —Ä–µ–Ω–¥–µ—Ä—è—Ç—Å—è –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è -->
  <div class="messages" id="messagesContainer"></div>

  <!-- –ö–Ω–æ–ø–∫–∞ ¬´—Å–∫—Ä–æ–ª–ª –∫ –Ω–∏–∑—É¬ª -->
  <button id="scrollToBottomBtn">‚¨áÔ∏é</button>

  <!-- –ú–æ–¥–∞–ª–∫–∞ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ + –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è -->
  <div id="fileModalOverlay">
    <div>
      <h3>–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–∞–π–ª</h3>
      <input type="file" id="modalFileInput" />
      <textarea 
        id="fileComment" 
        placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"
      ></textarea>
      <button id="sendFileWithCommentBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      <button id="cancelFileBtn" class="cancel">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>

  <!-- –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å –≤–≤–æ–¥–∞ –≤–Ω–∏–∑—É -->
  <div class="input-bar">
    <textarea 
      id="messageInput" 
      placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." 
      rows="1"
    ></textarea>
    <button id="sendBtn" disabled>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    <button id="sendFileBtn">üìé</button>
  </div>

  <script>
    Telegram.WebApp.ready();

    (function() {
      const params = new URLSearchParams(window.location.search);
      const chatId = params.get('chatId');
      const user = Telegram.WebApp.initDataUnsafe?.user;
      if (!user || !chatId) {
        document.getElementById('messagesContainer').innerHTML =
          '<p style="padding:12px; text-align:center;">–ù–µ–≤–µ—Ä–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã.</p>';
        return;
      }
      const userId = String(user.id);

      // –û–ø—Ä–µ–¥–µ–ª–∏–º ¬´–¥—Ä—É–≥–æ–≥–æ¬ª –ø–æ chatId
      const [u1, u2] = chatId.split('_');
      const other = (u1 === userId ? u2 : u1);

      const chatTitleEl       = document.getElementById('chatTitle');
      const statusEl          = document.getElementById('status');
      const backBtn           = document.getElementById('backBtn');
      const msgContainer      = document.getElementById('messagesContainer');
      const inputEl           = document.getElementById('messageInput');
      const sendBtn           = document.getElementById('sendBtn');
      const sendFileBtn       = document.getElementById('sendFileBtn');
      const scrollToBottomBtn = document.getElementById('scrollToBottomBtn');

      // –ú–æ–¥–∞–ª–∫–∞ –¥–ª—è —Ñ–∞–π–ª–∞
      const fileModalOverlay       = document.getElementById('fileModalOverlay');
      const modalFileInput         = document.getElementById('modalFileInput');
      const fileCommentInput       = document.getElementById('fileComment');
      const sendFileWithCommentBtn = document.getElementById('sendFileWithCommentBtn');
      const cancelFileBtn          = document.getElementById('cancelFileBtn');

      chatTitleEl.textContent = `–ß–∞—Ç —Å ${other}`;

      backBtn.onclick = () => {
        window.location.href = 'index.html';
      };

      // --- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ ---
      async function updateStatus() {
        try {
          const res = await fetch(`/api/status?userId=${encodeURIComponent(other)}`);
          if (!res.ok) throw new Error();
          const data = await res.json();
          statusEl.textContent = data.online ? '–æ–Ω–ª–∞–π–Ω' : '–æ—Ñ–ª–∞–π–Ω';
          statusEl.style.color   = data.online ? '#7CFC00' : '#888';
        } catch(e) {
          console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å:', e);
        }
      }
      updateStatus();
      setInterval(updateStatus, 5000);

      // --- Reply: id —Å–æ–æ–±—â–µ–Ω–∏—è, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–µ –æ—Ç–≤–µ—á–∞–µ–º ---
      let replyToId = null;

      function renderReplyPreview(text) {
        const existing = document.getElementById('replyPreview');
        if (existing) existing.remove();
        if (!text) return;
        const div = document.createElement('div');
        div.id = 'replyPreview';
        div.style.padding = '6px 12px';
        div.style.backgroundColor = 'rgba(50,50,50,0.7)';
        div.style.borderLeft = '3px solid #666';
        div.style.margin = '8px 20px 0 20px';
        div.style.borderRadius = '8px';
        div.style.maxWidth = '80%';
        div.style.whiteSpace = 'nowrap';
        div.style.overflow = 'hidden';
        div.style.textOverflow = 'ellipsis';
        div.style.fontSize = '14px';
        div.textContent = `–û—Ç–≤–µ—Ç –Ω–∞: ${text}`;
        document.body.insertBefore(div, document.querySelector('.input-bar'));
      }

      // --- –ó–∞–≥—Ä—É–∑–∫–∞ –∏ —Ä–µ–Ω–¥–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π ---
      async function loadMessages() {
        try {
          const res = await fetch(
            `/api/messages?chatId=${encodeURIComponent(chatId)}&userId=${encodeURIComponent(userId)}`
          );
          if (!res.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è');
          const msgs = await res.json();
          msgContainer.innerHTML = '';

          msgs.forEach(m => {
            const div = document.createElement('div');
            div.classList.add('message', (m.from === userId ? 'me' : 'you'));

            // –ï—Å–ª–∏ —ç—Ç–æ –æ—Ç–≤–µ—Ç (m.replyTo), –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—Å—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª–∞ –∏–ª–∏ ‚Äú[—Ñ–∞–π–ª]‚Äù
            if (m.replyTo) {
              const replied = msgs.find(x => x.id === m.replyTo);
              if (replied) {
                const replyDiv = document.createElement('div');
                replyDiv.classList.add('replyTo');
                replyDiv.textContent = replied.text
                  ? replied.text
                  : '[—Ñ–∞–π–ª]';
                div.appendChild(replyDiv);
              }
            }

            // ¬´–ü—É–∑—ã—Ä—ë–∫¬ª —Å —Å–æ–¥–µ—Ä–∂–∏–º—ã–º
            const bubble = document.createElement('div');
            bubble.classList.add('bubble');

            // –¢–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–ª–∏–±–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ —Ñ–∞–π–ª—É)
            if (m.text && !m.file) {
              bubble.textContent = m.text;
            }

            // –ï—Å–ª–∏ –µ—Å—Ç—å —Ñ–∞–π–ª
            if (m.file) {
              const link = document.createElement('a');
              link.href = m.file;
              link.textContent = 'üìé –§–∞–π–ª';
              link.classList.add('fileLink');
              link.target = '_blank';
              bubble.appendChild(link);
              // –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –ø–æ–¥ —Å—Å—ã–ª–∫–æ–π
              if (m.text) {
                const commentDiv = document.createElement('div');
                commentDiv.classList.add('fileComment');
                commentDiv.textContent = m.text;
                bubble.appendChild(commentDiv);
              }
            }

            // –ò–∫–æ–Ω–∫–∞ ¬´‚Ü©¬ª (reply) –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É bubble
            const replyIcon = document.createElement('span');
            replyIcon.classList.add('replyIcon');
            replyIcon.textContent = '‚Ü©';
            replyIcon.onclick = (e) => {
              e.stopPropagation();
              replyToId = m.id;
              renderReplyPreview(m.text || (m.file ? '[—Ñ–∞–π–ª]' : ''));
            };
            bubble.appendChild(replyIcon);

            div.appendChild(bubble);

            // –ú–µ—Ç–∞-–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è: –≤—Ä–µ–º—è –∏ ¬´–í—ã/–°–æ–±–µ—Å–µ–¥–Ω–∏–∫¬ª
            const meta = document.createElement('div');
            meta.classList.add('meta');
            const date = new Date(m.ts);
            const hh = String(date.getHours()).padStart(2, '0');
            const mm = String(date.getMinutes()).padStart(2, '0');
            meta.textContent = (m.from === userId ? '–í—ã' : '–°–æ–±–µ—Å–µ–¥–Ω–∏–∫') + ` ‚Ä¢ ${hh}:${mm}`;
            div.appendChild(meta);

            msgContainer.appendChild(div);
          });

          // –ê–≤—Ç–æ-—Å–∫—Ä–æ–ª–ª –≤–Ω–∏–∑
          msgContainer.scrollTop = msgContainer.scrollHeight;

          // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É ¬´‚¨áÔ∏é¬ª, —Ç–∞–∫ –∫–∞–∫ –º—ã —É–∂–µ –≤–Ω–∏–∑—É
          scrollToBottomBtn.style.display = 'none';
        } catch (err) {
          console.error(err);
        }
      }

      loadMessages();
      setInterval(loadMessages, 1000);

      // --- –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∫—Ä–æ–ª–ª–∞ –≤ .messages: –µ—Å–ª–∏ –Ω–µ –≤–Ω–∏–∑—É, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É ‚Üì ---
      msgContainer.addEventListener('scroll', () => {
        const threshold = 50; // –ø–∏–∫—Å–µ–ª–µ–π –¥–æ –Ω–∏–∑–∞
        const distanceFromBottom = msgContainer.scrollHeight - (msgContainer.scrollTop + msgContainer.clientHeight);
        if (distanceFromBottom > threshold) {
          // –µ—Å–ª–∏ —Å–∏–ª—å–Ω–æ –ø—Ä–æ–∫—Ä—É—á–µ–Ω—ã –≤–≤–µ—Ä—Ö ‚Üí –ø–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫—É
          scrollToBottomBtn.style.display = 'flex';
        } else {
          scrollToBottomBtn.style.display = 'none';
        }
      });

      // –ü—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∫–Ω–æ–ø–∫—É ¬´‚¨áÔ∏é¬ª —Å–∫—Ä–æ–ª–ª–∏–º –≤ —Å–∞–º—ã–π –Ω–∏–∑
      scrollToBottomBtn.addEventListener('click', () => {
        msgContainer.scrollTop = msgContainer.scrollHeight;
        scrollToBottomBtn.style.display = 'none';
      });

      // --- –ê–≤—Ç–æ‚Äê—Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ textarea –ø–æ –≤–≤–æ–¥—É ---
      function autoResizeTextarea() {
        inputEl.style.height = 'auto';
        inputEl.style.height = inputEl.scrollHeight + 'px';
      }
      inputEl.addEventListener('input', () => {
        autoResizeTextarea();
        sendBtn.disabled = inputEl.value.trim() === '';
      });

      // --- –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è ---
      sendBtn.addEventListener('click', async () => {
        const text = inputEl.value.trim();
        if (!text) return;
        sendBtn.disabled = true;
        try {
          await fetch('/api/messages/send', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              chatId,
              from: userId,
              to: other,
              text,
              replyTo: replyToId
            })
          });
          replyToId = null;
          renderReplyPreview(null);
          inputEl.value = '';
          autoResizeTextarea();
          await loadMessages();
        } catch (err) {
          alert('–û—à–∏–±–∫–∞: ' + err.message);
          console.error(err);
        } finally {
          sendBtn.disabled = inputEl.value.trim() === '';
        }
      });

      // --- –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª–∫—É –¥–ª—è —Ñ–∞–π–ª–∞ ---
      sendFileBtn.addEventListener('click', () => {
        modalFileInput.value = '';
        fileCommentInput.value = '';
        fileModalOverlay.style.display = 'flex';
      });

      // --- –û—Ç–º–µ–Ω–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ ---
      cancelFileBtn.addEventListener('click', () => {
        fileModalOverlay.style.display = 'none';
      });

      // --- –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–∞–π–ª–∞ + –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è ---
      sendFileWithCommentBtn.addEventListener('click', async () => {
        if (!modalFileInput.files.length) {
          alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª');
          return;
        }
        const file = modalFileInput.files[0];
        const comment = fileCommentInput.value.trim();

        const formData = new FormData();
        formData.append('file', file);
        formData.append('chatId', chatId);
        formData.append('from', userId);
        formData.append('to', other);
        if (replyToId) formData.append('replyTo', replyToId);
        if (comment) formData.append('text', comment);

        try {
          await fetch('/api/messages/send-file', {
            method: 'POST',
            body: formData
          });
          replyToId = null;
          renderReplyPreview(null);
          fileModalOverlay.style.display = 'none';
          await loadMessages();
        } catch (err) {
          alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–∞–π–ª');
          console.error(err);
        } finally {
          modalFileInput.value = '';
        }
      });
    })();
  </script>
</body>
</html>
