<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
  />
  <title>–ß–∞—Ç</title>
  <link rel="stylesheet" href="css/style.css" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <header>
    <span id="backBtn" class="back-btn">&#8592;</span>
    <div class="header-info">
      <div id="chatTitle">–ß–∞—Ç</div>
      <div id="status">–æ—Ñ–ª–∞–π–Ω</div>
    </div>
    <!-- –ö–Ω–æ–ø–∫–∞ –º–µ–Ω—é -->
    <button id="menuBtn" class="header-btn">‚ãØ</button>
  </header>

  <!-- –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ -->
  <div class="messages" id="messagesContainer"></div>
  <button id="scrollToBottomBtn" class="scroll-btn">‚¨áÔ∏é</button>

  <!-- –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –¥–µ–π—Å—Ç–≤–∏–π -->
  <ul id="actionMenu" class="action-menu">
    <li id="openAdd">–î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞</li>
    <li id="openRemove">–£–¥–∞–ª–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞</li>
  </ul>

  <!-- –ú–æ–¥–∞–ª–∫–∞ ¬´–ü–æ–¥—Ä–æ–±–Ω–µ–µ¬ª -->
  <div id="detailsModal" class="modal-overlay">
    <div class="modal">
      <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ –∑–∞—è–≤–∫–µ</h3>
      <pre id="detailsText" class="details-text"></pre>
      <button id="closeDetailsBtn" class="cancel-btn">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ ¬´–î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞¬ª -->
  <div id="addModal" class="modal-overlay">
    <div class="modal">
      <h3>–î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞</h3>
      <input
        type="text"
        id="newParticipantInput"
        placeholder="ID –∏ —Ä–æ–ª—å, –Ω–∞–ø—Ä–∏–º–µ—Ä: 123456 –ú–∞—Å—Ç–µ—Ä"
      />
      <button id="addParticipantConfirmBtn">–î–æ–±–∞–≤–∏—Ç—å</button>
      <button id="addParticipantCancelBtn" class="cancel-btn">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ ¬´–£–¥–∞–ª–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞¬ª -->
  <div id="removeModal" class="modal-overlay">
    <div class="modal">
      <h3>–£–¥–∞–ª–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞</h3>
      <div id="removeList" class="remove-list"></div>
      <button id="closeRemoveBtn" class="cancel-btn">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ ¬´–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–∞–π–ª¬ª -->
  <div id="fileModalOverlay" class="modal-overlay">
    <div class="modal">
      <h3>–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–∞–π–ª</h3>
      <input type="file" id="modalFileInput" />
      <textarea id="fileComment" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"></textarea>
      <button id="sendFileWithCommentBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      <button id="cancelFileBtn" class="cancel-btn">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>

  <!-- –ü–∞–Ω–µ–ª—å –≤–≤–æ–¥–∞ -->
  <div class="input-bar">
    <textarea
      id="messageInput"
      placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."
      rows="1"
    ></textarea>
    <button id="sendBtn" disabled>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    <button id="sendFileBtn">üìé</button>
  </div>

  <script>
    Telegram.WebApp.ready();
    (async function() {
      const params = new URLSearchParams(location.search);
      const chatId = params.get('chatId');
      const user = Telegram.WebApp.initDataUnsafe?.user;
      if (!user || !chatId) {
        document.getElementById('messagesContainer').innerHTML =
          '<p class="error">–ù–µ–≤–µ—Ä–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã.</p>';
        return;
      }
      const userId = String(user.id);

      // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
      const backBtn = document.getElementById('backBtn');
      const chatTitleEl = document.getElementById('chatTitle');
      const statusEl = document.getElementById('status');
      const menuBtn = document.getElementById('menuBtn');
      const actionMenu = document.getElementById('actionMenu');
      const openAdd = document.getElementById('openAdd');
      const openRemove = document.getElementById('openRemove');
      const detailsModal = document.getElementById('detailsModal');
      const detailsText = document.getElementById('detailsText');
      const closeDetailsBtn = document.getElementById('closeDetailsBtn');
      const addModal = document.getElementById('addModal');
      const newParticipantInput = document.getElementById('newParticipantInput');
      const addParticipantConfirmBtn = document.getElementById('addParticipantConfirmBtn');
      const addParticipantCancelBtn = document.getElementById('addParticipantCancelBtn');
      const removeModal = document.getElementById('removeModal');
      const removeList = document.getElementById('removeList');
      const closeRemoveBtn = document.getElementById('closeRemoveBtn');
      const fileModalOverlay = document.getElementById('fileModalOverlay');
      const modalFileInput = document.getElementById('modalFileInput');
      const fileCommentInput = document.getElementById('fileComment');
      const sendFileWithCommentBtn = document.getElementById('sendFileWithCommentBtn');
      const cancelFileBtn = document.getElementById('cancelFileBtn');
      const msgContainer = document.getElementById('messagesContainer');
      const scrollBtn = document.getElementById('scrollToBottomBtn');
      const inputEl = document.getElementById('messageInput');
      const sendBtn = document.getElementById('sendBtn');
      const sendFileBtn = document.getElementById('sendFileBtn');

      let meta = { participants: [] };
      let replyToId = null;

      backBtn.onclick = () => (location.href = 'index.html');

      // –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é ‚ãØ
      menuBtn.onclick = (e) => {
        actionMenu.style.display = 'block';
        actionMenu.style.top = e.clientY + 'px';
        actionMenu.style.left = e.clientX - 80 + 'px';
      };
      document.addEventListener('click', (e) => {
        if (!actionMenu.contains(e.target) && e.target !== menuBtn) {
          actionMenu.style.display = 'none';
        }
      });

      // ¬´–î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞¬ª
      openAdd.onclick = () => {
        actionMenu.style.display = 'none';
        newParticipantInput.value = '';
        addModal.style.display = 'flex';
      };
      addParticipantCancelBtn.onclick = () => (addModal.style.display = 'none');
      addParticipantConfirmBtn.onclick = async () => {
        const val = newParticipantInput.value.trim();
        if (!val) return alert('–í–≤–µ–¥–∏—Ç–µ ID –∏ —Ä–æ–ª—å');
        const [uid, ...roleArr] = val.split(' ');
        try {
          const res = await fetch('/api/add-to-chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ chatId, userId: uid, role: roleArr.join(' ') }),
          });
          if (!res.ok) throw '';
          addModal.style.display = 'none';
          await load();
        } catch {
          alert('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è');
        }
      };

      // ¬´–£–¥–∞–ª–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞¬ª
      openRemove.onclick = () => {
        actionMenu.style.display = 'none';
        removeList.innerHTML = '';
        const parts = meta.participants || [];
        // –¢–æ–ª—å–∫–æ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ (–∏–Ω–¥–µ–∫—Å—ã ‚â• 2)
        parts.slice(2).forEach((p) => {
          const div = document.createElement('div');
          div.className = 'remove-item';
          div.innerHTML = `
            <span>${p.id} (${p.role})</span>
            <button data-id="${p.id}" class="remove-btn">–£–¥–∞–ª–∏—Ç—å</button>
          `;
          removeList.appendChild(div);
        });
        removeModal.style.display = 'flex';
      };
      closeRemoveBtn.onclick = () => (removeModal.style.display = 'none');
      removeList.onclick = async (e) => {
        if (!e.target.classList.contains('remove-btn')) return;
        const uid = e.target.dataset.id;
        try {
          const res = await fetch('/api/remove-from-chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ chatId, userId: uid }),
          });
          if (!res.ok) throw '';
          removeModal.style.display = 'none';
          await load();
        } catch {
          alert('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞');
        }
      };

      // ¬´–ü–æ–¥—Ä–æ–±–Ω–µ–µ¬ª
      openDetails = () => {
        const txt = 
          `–ó–∞—è–≤–∫–∞ #${meta.requestId}\n` +
          `–¢–∏–ø: ${meta.type}\n` +
          `–ê–¥—Ä–µ—Å: ${meta.address}\n` +
          `–î–∞—Ç–∞: ${meta.createdAt}`;
        detailsText.textContent = txt;
        detailsModal.style.display = 'flex';
      };
      closeDetailsBtn.onclick = () => {
        detailsModal.style.display = 'none';
        setTimeout(() => inputEl.focus(), 100);
      };
      // –ü—Ä–∏–≤—è–∑–∞—Ç—å –∫ –ø—É–Ω–∫—Ç—É –º–µ–Ω—é?
      // –î–ª—è –ø—Ä–∏–º–µ—Ä–∞, –¥–∞—ë–º –¥–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –ø–æ –∑–∞–≥–æ–ª–æ–≤–∫—É
      chatTitleEl.ondblclick = openDetails;

      // ¬´–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–∞–π–ª¬ª
      sendFileBtn.onclick = () => {
        modalFileInput.value = '';
        fileCommentInput.value = '';
        fileModalOverlay.style.display = 'flex';
      };
      cancelFileBtn.onclick = () => (fileModalOverlay.style.display = 'none');
      sendFileWithCommentBtn.onclick = async () => {
        if (!modalFileInput.files.length) return alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª');
        const file = modalFileInput.files[0];
        const comment = fileCommentInput.value.trim();
        const parts = meta.participants || [];
        const other = parts.find((p) => p.id !== userId)?.id;
        const form = new FormData();
        form.append('file', file);
        form.append('chatId', chatId);
        form.append('from', userId);
        form.append('to', other);
        if (replyToId) form.append('replyTo', replyToId);
        if (comment) form.append('text', comment);
        try {
          await fetch('/api/messages/send-file', { method: 'POST', body: form });
          fileModalOverlay.style.display = 'none';
          replyToId = null;
          renderReplyPreview(null);
          await load();
        } catch {
          alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–∞–π–ª–∞');
        }
      };

      // –ó–∞–≥—Ä—É–∑–∫–∞ –∏ —Ä–µ–Ω–¥–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π
      async function load() {
        try {
          const res = await fetch(`/api/messages?chatId=${encodeURIComponent(chatId)}&userId=${encodeURIComponent(userId)}`);
          const { messages, meta: m } = await res.json();
          meta = m;
          chatTitleEl.textContent = `–ß–∞—Ç –ø–æ –∑–∞—è–≤–∫–µ #${meta.requestId}`;

          // –°—Ç–∞—Ç—É—Å –æ–Ω–ª–∞–π–Ω
          const other = meta.participants.find(p => p.id !== userId)?.id;
          if (other) {
            const r = await fetch(`/api/status?userId=${encodeURIComponent(other)}`);
            const j = await r.json();
            statusEl.textContent = j.online ? '–æ–Ω–ª–∞–π–Ω' : '–æ—Ñ–ª–∞–π–Ω';
            statusEl.style.color = j.online ? '#7CFC00' : '#888';
          }

          const wasAtBottom = msgContainer.scrollTop + msgContainer.clientHeight >= msgContainer.scrollHeight - 50;
          msgContainer.innerHTML = '';

          messages.forEach((m) => {
            const div = document.createElement('div');
            div.className = 'message ' + (m.from === userId ? 'me' : 'you');

            if (m.replyTo) {
              const rep = messages.find(x => x.id === m.replyTo);
              if (rep) {
                const rv = document.createElement('div');
                rv.className = 'replyTo';
                rv.textContent = rep.text ? rep.text : '[—Ñ–∞–π–ª]';
                div.appendChild(rv);
              }
            }

            const bubble = document.createElement('div');
            bubble.className = 'bubble';
            if (m.text && !m.file) bubble.textContent = m.text;
            if (m.file) {
              const a = document.createElement('a');
              a.href = m.file;
              a.textContent = 'üìé –§–∞–π–ª';
              a.className = 'fileLink';
              a.target = '_blank';
              bubble.appendChild(a);
              if (m.text) {
                const c = document.createElement('div');
                c.className = 'fileComment';
                c.textContent = m.text;
                bubble.appendChild(c);
              }
            }

            const rp = document.createElement('span');
            rp.className = 'replyIcon';
            rp.textContent = '‚Ü©';
            rp.onclick = (e) => {
              e.stopPropagation();
              replyToId = m.id;
              renderReplyPreview(m.text || (m.file ? '[—Ñ–∞–π–ª]' : ''));
            };
            bubble.appendChild(rp);
            div.appendChild(bubble);

            const md = document.createElement('div');
            md.className = 'meta';
            let label;
            if (m.from === userId) label = '–í—ã';
            else {
              const p = meta.participants.find(x => x.id === m.from);
              const ru = p?.role?.toLowerCase();
              if (ru === 'manager') label = '–ú–µ–Ω–µ–¥–∂–µ—Ä';
              else if (ru === 'client') label = '–ö–ª–∏–µ–Ω—Ç';
              else if (p && p.role) label = p.role.charAt(0).toUpperCase() + p.role.slice(1);
              else label = '–°–æ–±–µ—Å–µ–¥–Ω–∏–∫';
            }
            const dt = new Date(m.ts);
            const hh = String(dt.getHours()).padStart(2, '0');
            const mm = String(dt.getMinutes()).padStart(2, '0');
            md.textContent = `${label} ‚Ä¢ ${hh}:${mm}`;
            div.appendChild(md);

            msgContainer.appendChild(div);
          });

          if (wasAtBottom) {
            msgContainer.scrollTop = msgContainer.scrollHeight;
            scrollBtn.style.display = 'none';
          }
        } catch (e) {
          console.error(e);
        }
      }

      // –ü—Ä–µ–≤—å—é –æ—Ç–≤–µ—Ç–∞
      function renderReplyPreview(text) {
        let ex = document.getElementById('replyPreview');
        if (ex) ex.remove();
        if (!text) return;
        const d = document.createElement('div');
        d.id = 'replyPreview';
        d.className = 'replyPreview';
        d.textContent = `–û—Ç–≤–µ—Ç –Ω–∞: ${text}`;
        document.body.insertBefore(d, document.querySelector('.input-bar'));
      }

      // –ê–≤—Ç–æ‚Äë—Ä–∞–∑–º–µ—Ä textarea
      function autoResize() {
        inputEl.style.height = 'auto';
        inputEl.style.height = inputEl.scrollHeight + 'px';
      }
      inputEl.addEventListener('input', () => {
        autoResize();
        sendBtn.disabled = !inputEl.value.trim();
      });

      // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ–∫—Å—Ç–∞
      sendBtn.onclick = async () => {
        const text = inputEl.value.trim();
        if (!text) return;
        sendBtn.disabled = true;
        const other = meta.participants.find(p => p.id !== userId)?.id;
        try {
          await fetch('/api/messages/send', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ chatId, from: userId, to: other, text, replyTo: replyToId })
          });
          replyToId = null;
          renderReplyPreview(null);
          inputEl.value = '';
          autoResize();
          await load();
        } catch (e) {
          alert('–û—à–∏–±–∫–∞: ' + e.message);
        } finally {
          sendBtn.disabled = !inputEl.value.trim();
        }
      };

      // –ö–Ω–æ–ø–∫–∞ —Å–∫—Ä–æ–ª–ª–∞
      msgContainer.addEventListener('scroll', () => {
        const dist = msgContainer.scrollHeight - (msgContainer.scrollTop + msgContainer.clientHeight);
        scrollBtn.style.display = dist > 50 ? 'flex' : 'none';
      });
      scrollBtn.onclick = () => {
        msgContainer.scrollTop = msgContainer.scrollHeight;
        scrollBtn.style.display = 'none';
      };

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
      await load();
      setInterval(load, 1000);
    })();
  </script>
</body>
</html>
