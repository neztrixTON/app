<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
  />
  <title>–ß–∞—Ç</title>
  <link rel="stylesheet" href="css/style.css" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <header>
    <span id="backBtn" class="back-btn">&#8592;</span>
    <div class="header-info">
      <div id="chatTitle">–ß–∞—Ç</div>
      <div id="status">–æ—Ñ–ª–∞–π–Ω</div>
    </div>
    <button id="detailsBtn" class="header-btn">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</button>
    <button id="addParticipantBtn" class="header-btn" style="display: none;">
      –î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞
    </button>
  </header>

  <div class="messages" id="messagesContainer"></div>
  <button id="scrollToBottomBtn" class="scroll-btn">‚¨áÔ∏é</button>

  <!-- –ú–æ–¥–∞–ª–∫–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–∞–π–ª–∞ + –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è -->
  <div id="fileModalOverlay" class="modal-overlay">
    <div class="modal">
      <h3>–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–∞–π–ª</h3>
      <input type="file" id="modalFileInput" />
      <textarea
        id="fileComment"
        placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"
      ></textarea>
      <button id="sendFileWithCommentBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      <button id="cancelFileBtn" class="cancel-btn">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–∞ -->
  <div id="participantModalOverlay" class="modal-overlay">
    <div class="modal">
      <h3>–î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞</h3>
      <input
        type="text"
        id="newParticipantInput"
        placeholder="ID —É—á–∞—Å—Ç–Ω–∏–∫–∞ –∏ —Ä–æ–ª—å, –Ω–∞–ø—Ä–∏–º–µ—Ä: 123456 –ú–∞—Å—Ç–µ—Ä"
      />
      <button id="addParticipantConfirmBtn">–î–æ–±–∞–≤–∏—Ç—å</button>
      <button id="addParticipantCancelBtn" class="cancel-btn">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>

  <!-- –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å –≤–≤–æ–¥–∞ -->
  <div class="input-bar">
    <textarea
      id="messageInput"
      placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."
      rows="1"
    ></textarea>
    <button id="sendBtn" disabled>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    <button id="sendFileBtn">üìé</button>
  </div>

  <script>
    Telegram.WebApp.ready();

    (async function () {
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
      const params = new URLSearchParams(window.location.search);
      const chatId = params.get("chatId");
      const user = Telegram.WebApp.initDataUnsafe?.user;
      if (!user || !chatId) {
        document.getElementById("messagesContainer").innerHTML =
          '<p style="padding:12px; text-align:center;">–ù–µ–≤–µ—Ä–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã.</p>';
        return;
      }
      const userId = String(user.id);

      // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
      const backBtn = document.getElementById("backBtn");
      const chatTitleEl = document.getElementById("chatTitle");
      const statusEl = document.getElementById("status");
      const detailsBtn = document.getElementById("detailsBtn");
      const addParticipantBtn = document.getElementById(
        "addParticipantBtn"
      );
      const msgContainer = document.getElementById("messagesContainer");
      const scrollBtn = document.getElementById("scrollToBottomBtn");

      const fileModalOverlay = document.getElementById("fileModalOverlay");
      const modalFileInput = document.getElementById("modalFileInput");
      const fileCommentInput = document.getElementById("fileComment");
      const sendFileWithCommentBtn = document.getElementById(
        "sendFileWithCommentBtn"
      );
      const cancelFileBtn = document.getElementById("cancelFileBtn");

      const participantModalOverlay = document.getElementById(
        "participantModalOverlay"
      );
      const newParticipantInput = document.getElementById(
        "newParticipantInput"
      );
      const addParticipantConfirmBtn = document.getElementById(
        "addParticipantConfirmBtn"
      );
      const addParticipantCancelBtn = document.getElementById(
        "addParticipantCancelBtn"
      );

      const inputEl = document.getElementById("messageInput");
      const sendBtn = document.getElementById("sendBtn");
      const sendFileBtn = document.getElementById("sendFileBtn");

      let meta = {};
      let replyToId = null;

      // –ù–∞–≤–∏–≥–∞—Ü–∏—è –Ω–∞–∑–∞–¥
      backBtn.onclick = () => (window.location.href = "index.html");

      // –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –∑–∞—è–≤–∫–∏
      detailsBtn.onclick = () => {
        alert(
          `–ó–∞—è–≤–∫–∞ #${meta.requestId}\n–¢–∏–ø: ${meta.type}\n–ê–¥—Ä–µ—Å: ${meta.address}\n–î–∞—Ç–∞: ${meta.createdAt}`
        );
      };

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ ¬´–î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞¬ª
      addParticipantBtn.onclick = () => {
        newParticipantInput.value = "";
        participantModalOverlay.style.display = "flex";
      };
      addParticipantCancelBtn.onclick = () => {
        participantModalOverlay.style.display = "none";
      };
      addParticipantConfirmBtn.onclick = async () => {
        const val = newParticipantInput.value.trim();
        if (!val) return alert("–í–≤–µ–¥–∏—Ç–µ ID –∏ —Ä–æ–ª—å");
        const [uid, ...roleArr] = val.split(" ");
        const role = roleArr.join(" ");
        try {
          const r = await fetch("/api/add-to-chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ chatId, userId: uid, role }),
          });
          if (!r.ok) throw new Error();
          alert("–£—á–∞—Å—Ç–Ω–∏–∫ –¥–æ–±–∞–≤–ª–µ–Ω");
          participantModalOverlay.style.display = "none";
        } catch {
          alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏");
        }
      };

      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ ¬´–æ–Ω–ª–∞–π–Ω/–æ—Ñ–ª–∞–π–Ω¬ª
      async function updateStatus() {
        const other = meta.participants?.find((p) => p.id !== userId)?.id;
        if (!other) return;
        try {
          const res = await fetch(
            `/api/status?userId=${encodeURIComponent(other)}`
          );
          const data = await res.json();
          statusEl.textContent = data.online ? "–æ–Ω–ª–∞–π–Ω" : "–æ—Ñ–ª–∞–π–Ω";
          statusEl.style.color = data.online ? "#7CFC00" : "#888";
        } catch {}
      }

      // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
      async function load() {
        try {
          const res = await fetch(
            `/api/messages?chatId=${encodeURIComponent(
              chatId
            )}&userId=${encodeURIComponent(userId)}`
          );
          const body = await res.json();
          const msgs = body.messages;
          meta = body.meta;

          // –û–±–Ω–æ–≤—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å –Ω–æ–º–µ—Ä–æ–º –∑–∞—è–≤–∫–∏
          chatTitleEl.textContent = `–ó–∞—è–≤–∫–∞ #${meta.requestId}`;

          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É ¬´–î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞¬ª –µ—Å–ª–∏ –∞–¥–º–∏–Ω
          if (body.meta.isAdmin) {
            addParticipantBtn.style.display = "inline-block";
          }

          // –†–µ–Ω–¥–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π
          const wasAtBottom =
            msgContainer.scrollTop + msgContainer.clientHeight >=
            msgContainer.scrollHeight - 50;
          msgContainer.innerHTML = "";
          msgs.forEach((m) => {
            const div = document.createElement("div");
            div.classList.add("message", m.from === userId ? "me" : "you");

            // –û—Ç–≤–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ
            if (m.replyTo) {
              const replied = msgs.find((x) => x.id === m.replyTo);
              if (replied) {
                const replyDiv = document.createElement("div");
                replyDiv.classList.add("replyTo");
                replyDiv.textContent = replied.text
                  ? replied.text
                  : "[—Ñ–∞–π–ª]";
                div.appendChild(replyDiv);
              }
            }

            // –ü—É–∑—ã—Ä—ë–∫
            const bubble = document.createElement("div");
            bubble.classList.add("bubble");
            if (m.text && !m.file) {
              bubble.textContent = m.text;
            }
            if (m.file) {
              const link = document.createElement("a");
              link.href = m.file;
              link.textContent = "üìé –§–∞–π–ª";
              link.classList.add("fileLink");
              link.target = "_blank";
              bubble.appendChild(link);
              if (m.text) {
                const comment = document.createElement("div");
                comment.classList.add("fileComment");
                comment.textContent = m.text;
                bubble.appendChild(comment);
              }
            }

            // –ö–Ω–æ–ø–∫–∞ ¬´‚Ü©¬ª –¥–ª—è –æ—Ç–≤–µ—Ç–∞
            const replyIcon = document.createElement("span");
            replyIcon.classList.add("replyIcon");
            replyIcon.textContent = "‚Ü©";
            replyIcon.onclick = (e) => {
              e.stopPropagation();
              replyToId = m.id;
              renderReplyPreview(m.text || (m.file ? "[—Ñ–∞–π–ª]" : ""));
            };
            bubble.appendChild(replyIcon);

            div.appendChild(bubble);

            // –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ: –≤—Ä–µ–º—è
            const metaDiv = document.createElement("div");
            metaDiv.classList.add("meta");
            const dt = new Date(m.ts);
            const hh = String(dt.getHours()).padStart(2, "0");
            const mm = String(dt.getMinutes()).padStart(2, "0");
            metaDiv.textContent =
              (m.from === userId ? "–í—ã" : "–°–æ–±–µ—Å–µ–¥–Ω–∏–∫") + ` ‚Ä¢ ${hh}:${mm}`;
            div.appendChild(metaDiv);

            msgContainer.appendChild(div);
          });

          if (wasAtBottom) {
            msgContainer.scrollTop = msgContainer.scrollHeight;
            scrollBtn.style.display = "none";
          }
        } catch (e) {
          console.error(e);
        }
      }

      // –ü—Ä–µ–≤—å—é –¥–ª—è –æ—Ç–≤–µ—Ç–∞
      function renderReplyPreview(text) {
        const existing = document.getElementById("replyPreview");
        if (existing) existing.remove();
        if (!text) return;
        const div = document.createElement("div");
        div.id = "replyPreview";
        div.textContent = `–û—Ç–≤–µ—Ç –Ω–∞: ${text}`;
        div.className = "replyPreview";
        document.body.insertBefore(
          div,
          document.querySelector(".input-bar")
        );
      }

      // –ê–≤—Ç–æ‚Äë—Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ textarea
      function autoResizeTextarea() {
        inputEl.style.height = "auto";
        inputEl.style.height = inputEl.scrollHeight + "px";
      }

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
      msgContainer.addEventListener("scroll", () => {
        const dist =
          msgContainer.scrollHeight -
          (msgContainer.scrollTop + msgContainer.clientHeight);
        scrollBtn.style.display = dist > 50 ? "flex" : "none";
      });
      scrollBtn.addEventListener("click", () => {
        msgContainer.scrollTop = msgContainer.scrollHeight;
        scrollBtn.style.display = "none";
      });

      // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ–∫—Å—Ç–∞
      inputEl.addEventListener("input", () => {
        autoResizeTextarea();
        sendBtn.disabled = inputEl.value.trim() === "";
      });
      sendBtn.addEventListener("click", async () => {
        const text = inputEl.value.trim();
        if (!text) return;
        sendBtn.disabled = true;
        try {
          await fetch("/api/messages/send", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              chatId,
              from: userId,
              to: meta.participants.find((p) => p.id !== userId).id,
              text,
              replyTo: replyToId,
            }),
          });
          // —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –±–æ—Ç—É
          Telegram.WebApp.sendData(
            JSON.stringify({
              type: "message",
              chatId,
              from: userId,
              to: meta.participants
                .map((p) => p.id)
                .filter((id) => id !== userId)[0],
              text,
            })
          );
          replyToId = null;
          renderReplyPreview(null);
          inputEl.value = "";
          autoResizeTextarea();
          await load();
        } catch (e) {
          alert("–û—à–∏–±–∫–∞: " + e.message);
        } finally {
          sendBtn.disabled = inputEl.value.trim() === "";
        }
      });

      // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–∞–π–ª–∞
      sendFileBtn.addEventListener("click", () => {
        modalFileInput.value = "";
        fileCommentInput.value = "";
        fileModalOverlay.style.display = "flex";
      });
      cancelFileBtn.addEventListener("click", () => {
        fileModalOverlay.style.display = "none";
      });
      sendFileWithCommentBtn.addEventListener("click", async () => {
        if (!modalFileInput.files.length) {
          return alert("–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª");
        }
        const file = modalFileInput.files[0];
        const comment = fileCommentInput.value.trim();
        const form = new FormData();
        form.append("file", file);
        form.append("chatId", chatId);
        form.append("from", userId);
        form.append(
          "to",
          meta.participants.find((p) => p.id !== userId).id
        );
        if (replyToId) form.append("replyTo", replyToId);
        if (comment) form.append("text", comment);

        try {
          await fetch("/api/messages/send-file", {
            method: "POST",
            body: form,
          });
          // —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –±–æ—Ç—É
          Telegram.WebApp.sendData(
            JSON.stringify({
              type: "message",
              chatId,
              from: userId,
              to: meta.participants
                .map((p) => p.id)
                .filter((id) => id !== userId)[0],
              text: comment || "[—Ñ–∞–π–ª]",
            })
          );
          replyToId = null;
          renderReplyPreview(null);
          fileModalOverlay.style.display = "none";
          await load();
        } catch (e) {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–∞–π–ª");
        }
      });

      // –ü–µ—Ä–≤–∏—á–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã
      await load();
      setInterval(load, 1000);
      setInterval(updateStatus, 5000);
    })();
  </script>
</body>
</html>
