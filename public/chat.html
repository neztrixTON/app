<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport"
        content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
  <title>–ß–∞—Ç</title>
  <link rel="stylesheet" href="css/style.css"/>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <header>
    <span id="backBtn" class="back-btn">&#8592;</span>
    <div class="header-info">
      <div id="chatTitle">–ß–∞—Ç</div>
      <div id="status">–æ—Ñ–ª–∞–π–Ω</div>
    </div>
    <button id="detailsBtn" class="header-btn">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</button>
    <button id="addParticipantBtn" class="header-btn" style="display:none">–î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞</button>
  </header>

  <div class="messages" id="messagesContainer"></div>
  <button id="scrollToBottomBtn" class="scroll-btn">‚¨áÔ∏é</button>

  <!-- File modal -->
  <div id="fileModalOverlay" class="modal-overlay">
    <div class="modal">
      <h3>–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–∞–π–ª</h3>
      <input type="file" id="modalFileInput"/>
      <textarea id="fileComment" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"></textarea>
      <button id="sendFileWithCommentBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      <button id="cancelFileBtn" class="cancel-btn">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>

  <!-- Participant modal -->
  <div id="participantModalOverlay" class="modal-overlay">
    <div class="modal">
      <h3>–î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞</h3>
      <input type="text" id="newParticipantInput"
             placeholder="ID –∏ —Ä–æ–ª—å, –Ω–∞–ø—Ä–∏–º–µ—Ä: 123456 –ú–∞—Å—Ç–µ—Ä"/>
      <button id="addParticipantConfirmBtn">–î–æ–±–∞–≤–∏—Ç—å</button>
      <button id="addParticipantCancelBtn" class="cancel-btn">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>

  <!-- Input bar -->
  <div class="input-bar">
    <textarea id="messageInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." rows="1"></textarea>
    <button id="sendBtn" disabled>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    <button id="sendFileBtn">üìé</button>
  </div>

  <script>
    Telegram.WebApp.ready();
    (async function(){
      const params=new URLSearchParams(location.search);
      const chatId=params.get('chatId');
      const user=Telegram.WebApp.initDataUnsafe?.user;
      if(!user||!chatId){
        document.getElementById('messagesContainer').innerHTML=
          '<p style="padding:12px;text-align:center;">–ù–µ–≤–µ—Ä–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã.</p>';
        return;
      }
      const userId=String(user.id);

      // DOM
      const backBtn=document.getElementById('backBtn');
      const chatTitleEl=document.getElementById('chatTitle');
      const statusEl=document.getElementById('status');
      const detailsBtn=document.getElementById('detailsBtn');
      const addParticipantBtn=document.getElementById('addParticipantBtn');
      const msgContainer=document.getElementById('messagesContainer');
      const scrollBtn=document.getElementById('scrollToBottomBtn');
      const fileModalOverlay=document.getElementById('fileModalOverlay');
      const modalFileInput=document.getElementById('modalFileInput');
      const fileCommentInput=document.getElementById('fileComment');
      const sendFileWithCommentBtn=document.getElementById('sendFileWithCommentBtn');
      const cancelFileBtn=document.getElementById('cancelFileBtn');
      const participantModalOverlay=document.getElementById('participantModalOverlay');
      const newParticipantInput=document.getElementById('newParticipantInput');
      const addParticipantConfirmBtn=document.getElementById('addParticipantConfirmBtn');
      const addParticipantCancelBtn=document.getElementById('addParticipantCancelBtn');
      const inputEl=document.getElementById('messageInput');
      const sendBtn=document.getElementById('sendBtn');
      const sendFileBtn=document.getElementById('sendFileBtn');

      let meta={participants:[]}, replyToId=null, lastCount=0;

      backBtn.onclick=()=>location.href='index.html';
      detailsBtn.onclick=()=>{
        alert(
          `–ó–∞—è–≤–∫–∞ #${meta.requestId}\n–¢–∏–ø: ${meta.type}\n–ê–¥—Ä–µ—Å: ${meta.address}\n–î–∞—Ç–∞: ${meta.createdAt}`
        );
      };
      addParticipantBtn.onclick=()=>{
        newParticipantInput.value='';
        participantModalOverlay.style.display='flex';
      };
      addParticipantCancelBtn.onclick=()=>{
        participantModalOverlay.style.display='none';
      };
      addParticipantConfirmBtn.onclick=async()=>{
        const v=newParticipantInput.value.trim();
        if(!v) return alert('–í–≤–µ–¥–∏—Ç–µ ID –∏ —Ä–æ–ª—å');
        const [uid,...r]=v.split(' ');
        try{
          const res=await fetch('/api/add-to-chat',{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({chatId,userId:uid,role:r.join(' ')})
          });
          if(!res.ok) throw '';
          alert('–£—á–∞—Å—Ç–Ω–∏–∫ –¥–æ–±–∞–≤–ª–µ–Ω');
          participantModalOverlay.style.display='none';
          await load();
        }catch{
          alert('–û—à–∏–±–∫–∞');
        }
      };

      async function updateStatus(){
        const parts=Array.isArray(meta.participants)?meta.participants:[];
        const other=parts.find(p=>p.id!==userId)?.id;
        if(!other) return;
        try{
          const r=await fetch(`/api/status?userId=${other}`);
          const j=await r.json();
          statusEl.textContent=j.online?'–æ–Ω–ª–∞–π–Ω':'–æ—Ñ–ª–∞–π–Ω';
          statusEl.style.color=j.online?'#7CFC00':'#888';
        }catch{}
      }

      async function load(){
        const res=await fetch(`/api/messages?chatId=${chatId}&userId=${userId}`);
        const body=await res.json();
        const msgs=body.messages; meta=body.meta||{participants:[],isAdmin:false};

        // —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç –±–æ—Ç–∞ –ø—Ä–∏—Ö–æ–¥–∏—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
        if(msgs.length>lastCount && lastCount>0){
          // –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º —Ç—É—Ç, –ø—É—à–∏—Ç –±–æ—Ç
        }
        lastCount=msgs.length;

        const parts=Array.isArray(meta.participants)?meta.participants:[];
        const otherId=parts.find(p=>p.id!==userId)?.id;
        chatTitleEl.textContent=`–ó–∞—è–≤–∫–∞ #${meta.requestId||'?'}`;
        if(meta.isAdmin) addParticipantBtn.style.display='inline-block';

        const atBottom=msgContainer.scrollTop+msgContainer.clientHeight>=msgContainer.scrollHeight-50;
        msgContainer.innerHTML='';

        msgs.forEach(m=>{
          const div=document.createElement('div');
          div.className='message '+(m.from===userId?'me':'you');

          if(m.replyTo){
            const rep=msgs.find(x=>x.id===m.replyTo);
            if(rep){
              const rv=document.createElement('div');
              rv.className='replyTo';
              rv.textContent=rep.text?rep.text:'[—Ñ–∞–π–ª]';
              div.appendChild(rv);
            }
          }

          const bubble=document.createElement('div');
          bubble.className='bubble';
          if(m.text && !m.file) bubble.textContent=m.text;
          if(m.file){
            const a=document.createElement('a');
            a.href=m.file; a.textContent='üìé –§–∞–π–ª';
            a.className='fileLink'; a.target='_blank';
            bubble.appendChild(a);
            if(m.text){
              const cm=document.createElement('div');
              cm.className='fileComment';
              cm.textContent=m.text;
              bubble.appendChild(cm);
            }
          }

          const rp=document.createElement('span');
          rp.className='replyIcon'; rp.textContent='‚Ü©';
          rp.onclick=e=>{
            e.stopPropagation();
            replyToId=m.id;
            renderReplyPreview(m.text||(m.file?'[—Ñ–∞–π–ª]':''));
          };
          bubble.appendChild(rp);
          div.appendChild(bubble);

          const md=document.createElement('div');
          md.className='meta';
          let label;
          if(m.from===userId)           label='–í—ã';
          else{
            const p=parts.find(x=>x.id===m.from);
            const rl=p?.role?.toLowerCase();
            if(rl==='manager')          label='–ú–µ–Ω–µ–¥–∂–µ—Ä';
            else if(rl==='client')      label='–ö–ª–∏–µ–Ω—Ç';
            else if(p&&p.role)          label=p.role.charAt(0).toUpperCase()+p.role.slice(1);
            else                        label='–°–æ–±–µ—Å–µ–¥–Ω–∏–∫';
          }
          const dt=new Date(m.ts);
          const hh=String(dt.getHours()).padStart(2,'0');
          const mm=String(dt.getMinutes()).padStart(2,'0');
          md.textContent=`${label} ‚Ä¢ ${hh}:${mm}`;
          div.appendChild(md);

          msgContainer.appendChild(div);
        });

        if(atBottom){
          msgContainer.scrollTop=msgContainer.scrollHeight;
          scrollBtn.style.display='none';
        }
      }

      function renderReplyPreview(text){
        const ex=document.getElementById('replyPreview');
        if(ex) ex.remove();
        if(!text) return;
        const d=document.createElement('div');
        d.id='replyPreview'; d.className='replyPreview';
        d.textContent=`–û—Ç–≤–µ—Ç –Ω–∞: ${text}`;
        document.body.insertBefore(d,document.querySelector('.input-bar'));
      }
      function autoResize(){
        inputEl.style.height='auto';
        inputEl.style.height=inputEl.scrollHeight+'px';
      }

      msgContainer.onscroll=()=>{
        const dist=msgContainer.scrollHeight-(msgContainer.scrollTop+msgContainer.clientHeight);
        scrollBtn.style.display=dist>50?'flex':'none';
      };
      scrollBtn.onclick=()=>{
        msgContainer.scrollTop=msgContainer.scrollHeight;
        scrollBtn.style.display='none';
      };

      inputEl.oninput=()=>{
        autoResize();
        sendBtn.disabled=!inputEl.value.trim();
      };
      sendBtn.onclick=async()=>{
        const text=inputEl.value.trim();
        if(!text) return;
        sendBtn.disabled=true;
        try{
          const parts=Array.isArray(meta.participants)?meta.participants:[];
          const other=parts.find(p=>p.id!==userId)?.id;
          await fetch('/api/messages/send',{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({chatId,from:userId,to:other,text,replyTo:replyToId})
          });
          Telegram.WebApp.sendData(JSON.stringify({
            type:'message',chatId,from:userId,to:other,text
          }));
          replyToId=null; renderReplyPreview(null);
          inputEl.value=''; autoResize();
          await load();
        }catch(e){
          alert('–û—à–∏–±–∫–∞:'+e.message);
        }finally{
          sendBtn.disabled=!inputEl.value.trim();
        }
      };

      sendFileBtn.onclick=()=>{
        modalFileInput.value=''; fileCommentInput.value='';
        fileModalOverlay.style.display='flex';
      };
      cancelFileBtn.onclick=()=> fileModalOverlay.style.display='none';
      sendFileWithCommentBtn.onclick=async()=>{
        if(!modalFileInput.files.length) return alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª');
        const file=modalFileInput.files[0];
        const comment=fileCommentInput.value.trim();
        const parts=Array.isArray(meta.participants)?meta.participants:[];
        const other=parts.find(p=>p.id!==userId)?.id;
        const form=new FormData();
        form.append('file',file);
        form.append('chatId',chatId);
        form.append('from',userId);
        form.append('to',other);
        if(replyToId) form.append('replyTo',replyToId);
        if(comment)  form.append('text',comment);
        try{
          await fetch('/api/messages/send-file',{method:'POST',body:form});
          Telegram.WebApp.sendData(JSON.stringify({
            type:'message',chatId,from:userId,to:other,
            text:comment||'[—Ñ–∞–π–ª]'
          }));
          replyToId=null; renderReplyPreview(null);
          fileModalOverlay.style.display='none';
          await load();
        }catch{
          alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–∞–π–ª–∞');
        }
      };

      await load();
      setInterval(load,1000);
      setInterval(updateStatus,5000);
    })();
  </script>
</body>
</html>
