<!-- public/index.html -->
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta 
    name="viewport" 
    content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"
  />
  <title>Список чатов</title>
  <link rel="stylesheet" href="css/style.css" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <header>
    <h1>Мои чаты</h1>
  </header>
  <div class="chat-list" id="chatList"></div>

  <script>
    Telegram.WebApp.ready();
    (async () => {
      const user = Telegram.WebApp.initDataUnsafe.user;
      const list = document.getElementById('chatList');
      if (!user) {
        list.innerHTML = '<p>Ошибка инициализации</p>'; return;
      }
      try {
        const res = await fetch(`/api/chats?userId=${user.id}`);
        const chats = await res.json();
        if (!chats.length) {
          list.innerHTML = '<p>У вас нет чатов</p>'; return;
        }
        chats.forEach(c => {
          const div = document.createElement('div');
          div.className = 'chat-item';
          div.innerHTML = `
            <div class="chat-item__avatar">${c.title.charAt(0)}</div>
            <div class="chat-item__body">
              <div class="chat-item__title">${c.title}</div>
              <div class="chat-item__meta">
                <span class="role">${c.role}</span>
                <span class="unread">${c.unreadCount}</span>
              </div>
            </div>
            <div class="chat-item__actions">
              <button class="btn open">Открыть</button>
              <button class="btn details">Подробнее</button>
            </div>
          `;
          div.querySelector('.open').onclick = () => {
            Telegram.WebApp.openLink(`chat.html?chatId=${c.chatId}`);
          };
          div.querySelector('.details').onclick = async () => {
            const det = await fetch(`/api/chat/${c.chatId}/details`).then(r=>r.json());
            alert(JSON.stringify(det, null, 2));
          };
          list.appendChild(div);
        });
      } catch (e) {
        list.innerHTML = '<p>Ошибка загрузки</p>';
      }
    })();
  </script>
</body>
</html>
