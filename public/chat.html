<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
  />
  <title>–ß–∞—Ç</title>
  <link rel="stylesheet" href="css/style.css" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <header>
    <span id="backBtn" class="back-btn">&#8592;</span>
    <div class="header-info">
      <div id="chatTitle">–ß–∞—Ç</div>
      <div id="status">–æ—Ñ–ª–∞–π–Ω</div>
    </div>
    <button id="detailsBtn" class="header-btn">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</button>
    <button id="addParticipantBtn" class="header-btn" style="display:none">
      –î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞
    </button>
  </header>

  <div class="messages" id="messagesContainer"></div>
  <button id="scrollToBottomBtn" class="scroll-btn">‚¨áÔ∏é</button>

  <!-- –ú–æ–¥–∞–ª–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–∞–π–ª–∞ -->
  <div id="fileModalOverlay" class="modal-overlay">
    <div class="modal">
      <h3>–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–∞–π–ª</h3>
      <input type="file" id="modalFileInput" />
      <textarea id="fileComment" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"></textarea>
      <button id="sendFileWithCommentBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      <button id="cancelFileBtn" class="cancel-btn">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–∞ -->
  <div id="participantModalOverlay" class="modal-overlay">
    <div class="modal">
      <h3>–î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞</h3>
      <input
        type="text"
        id="newParticipantInput"
        placeholder="ID –∏ —Ä–æ–ª—å, –Ω–∞–ø—Ä–∏–º–µ—Ä: 123456 –ú–∞—Å—Ç–µ—Ä"
      />
      <button id="addParticipantConfirmBtn">–î–æ–±–∞–≤–∏—Ç—å</button>
      <button id="addParticipantCancelBtn" class="cancel-btn">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>

  <!-- –ü–∞–Ω–µ–ª—å –≤–≤–æ–¥–∞ -->
  <div class="input-bar">
    <textarea
      id="messageInput"
      placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."
      rows="1"
    ></textarea>
    <button id="sendBtn" disabled>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    <button id="sendFileBtn">üìé</button>
  </div>

  <script>
    Telegram.WebApp.ready();
    (async function() {
      const params = new URLSearchParams(location.search);
      const chatId = params.get('chatId');
      const user = Telegram.WebApp.initDataUnsafe?.user;
      if (!user || !chatId) {
        document.getElementById('messagesContainer').innerHTML =
          '<p style="padding:12px;text-align:center;">–ù–µ–≤–µ—Ä–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã.</p>';
        return;
      }
      const userId = String(user.id);

      // DOM elements
      const backBtn = document.getElementById('backBtn');
      const chatTitleEl = document.getElementById('chatTitle');
      const statusEl = document.getElementById('status');
      const detailsBtn = document.getElementById('detailsBtn');
      const addParticipantBtn = document.getElementById('addParticipantBtn');
      const msgContainer = document.getElementById('messagesContainer');
      const scrollBtn = document.getElementById('scrollToBottomBtn');
      const fileModalOverlay = document.getElementById('fileModalOverlay');
      const modalFileInput = document.getElementById('modalFileInput');
      const fileCommentInput = document.getElementById('fileComment');
      const sendFileWithCommentBtn = document.getElementById('sendFileWithCommentBtn');
      const cancelFileBtn = document.getElementById('cancelFileBtn');
      const participantModalOverlay = document.getElementById('participantModalOverlay');
      const newParticipantInput = document.getElementById('newParticipantInput');
      const addParticipantConfirmBtn = document.getElementById('addParticipantConfirmBtn');
      const addParticipantCancelBtn = document.getElementById('addParticipantCancelBtn');
      const inputEl = document.getElementById('messageInput');
      const sendBtn = document.getElementById('sendBtn');
      const sendFileBtn = document.getElementById('sendFileBtn');

      let meta = {}, replyToId = null;

      backBtn.onclick = () => location.href = 'index.html';
      detailsBtn.onclick = () => {
        alert(
          `–ó–∞—è–≤–∫–∞ #${meta.requestId}\n` +
          `–¢–∏–ø: ${meta.type}\n` +
          `–ê–¥—Ä–µ—Å: ${meta.address}\n` +
          `–î–∞—Ç–∞: ${meta.createdAt}`
        );
      };
      addParticipantBtn.onclick = () => {
        newParticipantInput.value = '';
        participantModalOverlay.style.display = 'flex';
      };
      addParticipantCancelBtn.onclick = () => {
        participantModalOverlay.style.display = 'none';
      };
      addParticipantConfirmBtn.onclick = async () => {
        const val = newParticipantInput.value.trim();
        if (!val) return alert('–í–≤–µ–¥–∏—Ç–µ ID –∏ —Ä–æ–ª—å');
        const [uid, ...roleArr] = val.split(' ');
        try {
          const res = await fetch('/api/add-to-chat', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({chatId, userId: uid, role: roleArr.join(' ')})
          });
          if (!res.ok) throw '';
          alert('–£—á–∞—Å—Ç–Ω–∏–∫ –¥–æ–±–∞–≤–ª–µ–Ω');
          participantModalOverlay.style.display = 'none';
          await load();
        } catch {
          alert('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è');
        }
      };

      async function updateStatus() {
        const other = meta.participants?.find(p=>p.id!==userId)?.id;
        if (!other) return;
        try {
          const r = await fetch(`/api/status?userId=${other}`);
          const j = await r.json();
          statusEl.textContent = j.online ? '–æ–Ω–ª–∞–π–Ω' : '–æ—Ñ–ª–∞–π–Ω';
          statusEl.style.color = j.online ? '#7CFC00' : '#888';
        } catch{}
      }

      async function load() {
        try {
          const res = await fetch(`/api/messages?chatId=${chatId}&userId=${userId}`);
          const body = await res.json();
          const msgs = body.messages;
          meta = body.meta;

          chatTitleEl.textContent = `–ó–∞—è–≤–∫–∞ #${meta.requestId}`;
          if (body.meta.isAdmin) addParticipantBtn.style.display = 'inline-block';

          const wasAtBottom = msgContainer.scrollTop + msgContainer.clientHeight >= msgContainer.scrollHeight - 50;
          msgContainer.innerHTML = '';
          msgs.forEach(m => {
            const div = document.createElement('div');
            div.className = 'message ' + (m.from===userId?'me':'you');
            if (m.replyTo) {
              const replied = msgs.find(x=>x.id===m.replyTo);
              if (replied) {
                const r = document.createElement('div');
                r.className = 'replyTo';
                r.textContent = replied.text ? replied.text : '[—Ñ–∞–π–ª]';
                div.appendChild(r);
              }
            }
            const bubble = document.createElement('div');
            bubble.className = 'bubble';
            if (m.text && !m.file) bubble.textContent = m.text;
            if (m.file) {
              const link = document.createElement('a');
              link.href = m.file;
              link.textContent = 'üìé –§–∞–π–ª';
              link.className = 'fileLink';
              link.target = '_blank';
              bubble.appendChild(link);
              if (m.text) {
                const com = document.createElement('div');
                com.className = 'fileComment';
                com.textContent = m.text;
                bubble.appendChild(com);
              }
            }
            const replyIcon = document.createElement('span');
            replyIcon.className = 'replyIcon';
            replyIcon.textContent = '‚Ü©';
            replyIcon.onclick = e => {
              e.stopPropagation();
              replyToId = m.id;
              renderReplyPreview(m.text|| (m.file?'[—Ñ–∞–π–ª]':''));
            };
            bubble.appendChild(replyIcon);
            div.appendChild(bubble);
            const md = document.createElement('div');
            md.className = 'meta';
            const dt = new Date(m.ts);
            md.textContent = (m.from===userId?'–í—ã':'–°–æ–±.') + ` ‚Ä¢ ${dt.getHours().toString().padStart(2,'0')}:${dt.getMinutes().toString().padStart(2,'0')}`;
            div.appendChild(md);
            msgContainer.appendChild(div);
          });
          if (wasAtBottom) {
            msgContainer.scrollTop = msgContainer.scrollHeight;
            scrollBtn.style.display = 'none';
          }
        } catch(e){
          console.error(e);
        }
      }

      function renderReplyPreview(text){
        const ex = document.getElementById('replyPreview');
        if (ex) ex.remove();
        if (!text) return;
        const d = document.createElement('div');
        d.id = 'replyPreview';
        d.className = 'replyPreview';
        d.textContent = `–û—Ç–≤–µ—Ç –Ω–∞: ${text}`;
        document.body.insertBefore(d, document.querySelector('.input-bar'));
      }

      function autoResize(){
        inputEl.style.height = 'auto';
        inputEl.style.height = inputEl.scrollHeight + 'px';
      }

      msgContainer.onscroll = () => {
        const dist = msgContainer.scrollHeight - (msgContainer.scrollTop+msgContainer.clientHeight);
        scrollBtn.style.display = dist>50?'flex':'none';
      };
      scrollBtn.onclick = () => {
        msgContainer.scrollTop = msgContainer.scrollHeight;
        scrollBtn.style.display = 'none';
      };

      inputEl.oninput = () => {
        autoResize();
        sendBtn.disabled = !inputEl.value.trim();
      };
      sendBtn.onclick = async () => {
        const text = inputEl.value.trim();
        if (!text) return;
        sendBtn.disabled = true;
        try {
          await fetch('/api/messages/send',{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({
              chatId, from:userId,
              to: meta.participants.find(p=>p.id!==userId).id,
              text, replyTo:replyToId
            })
          });
          Telegram.WebApp.sendData(JSON.stringify({
            type:'message', chatId, from:userId,
            to: meta.participants.map(p=>p.id).filter(id=>id!==userId)[0],
            text
          }));
          replyToId = null;
          renderReplyPreview(null);
          inputEl.value = '';
          autoResize();
          await load();
        } catch(e){
          alert('–û—à–∏–±–∫–∞: '+e.message);
        } finally {
          sendBtn.disabled = !inputEl.value.trim();
        }
      };

      sendFileBtn.onclick = () =>{
        modalFileInput.value = '';
        fileCommentInput.value = '';
        fileModalOverlay.style.display = 'flex';
      };
      cancelFileBtn.onclick = () =>{
        fileModalOverlay.style.display = 'none';
      };
      sendFileWithCommentBtn.onclick = async () => {
        if (!modalFileInput.files.length) return alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª');
        const file = modalFileInput.files[0];
        const comment = fileCommentInput.value.trim();
        const form = new FormData();
        form.append('file', file);
        form.append('chatId', chatId);
        form.append('from', userId);
        form.append('to', meta.participants.find(p=>p.id!==userId).id);
        if (replyToId) form.append('replyTo', replyToId);
        if (comment) form.append('text', comment);
        try {
          await fetch('/api/messages/send-file',{method:'POST', body:form});
          Telegram.WebApp.sendData(JSON.stringify({
            type:'message', chatId, from:userId,
            to: meta.participants.map(p=>p.id).filter(id=>id!==userId)[0],
            text: comment||'[—Ñ–∞–π–ª]'
          }));
          replyToId = null;
          renderReplyPreview(null);
          fileModalOverlay.style.display = 'none';
          await load();
        } catch {
          alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–∞–π–ª–∞');
        }
      };

      await load();
      setInterval(load,1000);
      setInterval(updateStatus,5000);
    })();
  </script>
</body>
</html>
