<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
  />
  <title>–ß–∞—Ç</title>
  <link rel="stylesheet" href="css/style.css" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <header>
    <span id="backBtn" class="back-btn">&#8592;</span>
    <div class="header-info">
      <div id="chatTitle">–ß–∞—Ç</div>
      <div id="status">–æ—Ñ–ª–∞–π–Ω</div>
    </div>
    <!-- –ö–Ω–æ–ø–∫–∞ ¬´–ü–æ–¥—Ä–æ–±–Ω–µ–µ¬ª –≤—Å–µ–≥–¥–∞ –≤–∏–¥–Ω–∞ -->
    <button id="detailsBtn" class="header-btn">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</button>
    <!-- –ö–Ω–æ–ø–∫–∞ ¬´‚ãØ¬ª –≤–∏–¥–Ω–∞ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∞–º -->
    <button id="menuBtn" class="header-btn">‚ãØ</button>
  </header>

  <div class="messages" id="messagesContainer"></div>
  <button id="scrollToBottomBtn" class="scroll-btn">‚¨áÔ∏é</button>

  <!-- –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –¥–µ–π—Å—Ç–≤–∏–π (–î–æ–±–∞–≤–∏—Ç—å/–£–¥–∞–ª–∏—Ç—å) -->
  <ul id="actionMenu" class="action-menu">
    <li id="openAdd">–î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞</li>
    <li id="openRemove">–£–¥–∞–ª–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞</li>
  </ul>

  <!-- –ú–æ–¥–∞–ª–∫–∞ ¬´–ü–æ–¥—Ä–æ–±–Ω–µ–µ¬ª -->
  <div id="detailsModal" class="modal-overlay">
    <div class="modal modal-centered">
      <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ –∑–∞—è–≤–∫–µ</h3>
      <pre id="detailsText" class="details-text"></pre>
      <button id="closeDetailsBtn" class="cancel-btn">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ ¬´–î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞¬ª -->
  <div id="addModal" class="modal-overlay">
    <div class="modal modal-centered">
      <h3>–î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞</h3>
      <input
        type="text"
        id="newParticipantInput"
        placeholder="ID –∏ —Ä–æ–ª—å, –Ω–∞–ø—Ä. 123456 –ú–∞—Å—Ç–µ—Ä"
      />
      <button id="addParticipantConfirmBtn">–î–æ–±–∞–≤–∏—Ç—å</button>
      <button id="addParticipantCancelBtn" class="cancel-btn">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ ¬´–£–¥–∞–ª–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞¬ª -->
  <div id="removeModal" class="modal-overlay">
    <div class="modal modal-centered">
      <h3>–£–¥–∞–ª–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞</h3>
      <div id="removeList" class="remove-list"></div>
      <button id="closeRemoveBtn" class="cancel-btn">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ ¬´–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–∞–π–ª¬ª -->
  <div id="fileModalOverlay" class="modal-overlay">
    <div class="modal modal-centered">
      <h3>–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–∞–π–ª</h3>
      <input type="file" id="modalFileInput" />
      <textarea id="fileComment" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"></textarea>
      <button id="sendFileWithCommentBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      <button id="cancelFileBtn" class="cancel-btn">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>

  <!-- –ü–∞–Ω–µ–ª—å –≤–≤–æ–¥–∞ -->
  <div class="input-bar">
    <textarea id="messageInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." rows="1"></textarea>
    <button id="sendBtn" disabled>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    <button id="sendFileBtn">üìé</button>
  </div>

  <script>
    Telegram.WebApp.ready();
    (async function() {
      const params = new URLSearchParams(location.search);
      const chatId = params.get('chatId');
      const user = Telegram.WebApp.initDataUnsafe?.user;
      if (!user || !chatId) {
        document.getElementById('messagesContainer').innerHTML =
          '<p class="error">–ù–µ–≤–µ—Ä–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã.</p>';
        return;
      }
      const userId = String(user.id);

      // DOM elements
      const backBtn = document.getElementById('backBtn');
      const chatTitleEl = document.getElementById('chatTitle');
      const statusEl = document.getElementById('status');
      const detailsBtn = document.getElementById('detailsBtn');
      const menuBtn = document.getElementById('menuBtn');
      const actionMenu = document.getElementById('actionMenu');
      const openAdd = document.getElementById('openAdd');
      const openRemove = document.getElementById('openRemove');
      const detailsModal = document.getElementById('detailsModal');
      const detailsText = document.getElementById('detailsText');
      const closeDetailsBtn = document.getElementById('closeDetailsBtn');
      const addModal = document.getElementById('addModal');
      const newParticipantInput = document.getElementById('newParticipantInput');
      const addParticipantConfirmBtn = document.getElementById('addParticipantConfirmBtn');
      const addParticipantCancelBtn = document.getElementById('addParticipantCancelBtn');
      const removeModal = document.getElementById('removeModal');
      const removeList = document.getElementById('removeList');
      const closeRemoveBtn = document.getElementById('closeRemoveBtn');
      const fileModalOverlay = document.getElementById('fileModalOverlay');
      const modalFileInput = document.getElementById('modalFileInput');
      const fileCommentInput = document.getElementById('fileComment');
      const sendFileWithCommentBtn = document.getElementById('sendFileWithCommentBtn');
      const cancelFileBtn = document.getElementById('cancelFileBtn');
      const msgContainer = document.getElementById('messagesContainer');
      const scrollBtn = document.getElementById('scrollToBottomBtn');
      const inputEl = document.getElementById('messageInput');
      const sendBtn = document.getElementById('sendBtn');
      const sendFileBtn = document.getElementById('sendFileBtn');

      let meta = { participants: [], isAdmin: false, requestId:'', type:'', address:'', createdAt: '' };
      let replyToId = null;

      backBtn.onclick = () => { window.location.href = 'index.html'; };

      // Load messages and metadata
      async function load() {
        try {
          const res = await fetch(`/api/messages?chatId=${encodeURIComponent(chatId)}&userId=${encodeURIComponent(userId)}`);
          if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
          const { messages, meta: m } = await res.json();
          meta = m;

          // Show or hide admin menu
          menuBtn.style.display = meta.isAdmin ? 'inline-block' : 'none';

          // Update header title and status
          chatTitleEl.textContent = `–ß–∞—Ç –ø–æ –∑–∞—è–≤–∫–µ #${meta.requestId}`;
          const other = meta.participants.find(p => p.id !== userId)?.id;
          if (other) {
            const st = await fetch(`/api/status?userId=${encodeURIComponent(other)}`).then(r=>r.json());
            statusEl.textContent = st.online ? '–æ–Ω–ª–∞–π–Ω' : '–æ—Ñ–ª–∞–π–Ω';
            statusEl.style.color = st.online ? '#7CFC00' : '#888';
          }

          // Render messages...
          const wasAtBottom = msgContainer.scrollTop + msgContainer.clientHeight >= msgContainer.scrollHeight - 20;
          msgContainer.innerHTML = '';
          messages.forEach(m => {
            const div = document.createElement('div');
            div.className = 'message ' + (m.from === userId ? 'me' : 'you');

            if (m.replyTo) {
              const rep = messages.find(x => x.id === m.replyTo);
              if (rep) {
                const rv = document.createElement('div');
                rv.className = 'replyTo';
                rv.textContent = rep.text || '[—Ñ–∞–π–ª]';
                div.appendChild(rv);
              }
            }

            const bubble = document.createElement('div');
            bubble.className = 'bubble';
            if (m.text && !m.file) bubble.textContent = m.text;
            if (m.file) {
              const a = document.createElement('a');
              a.href = m.file;
              a.textContent = 'üìé –§–∞–π–ª';
              a.target = '_blank';
              a.className = 'fileLink';
              bubble.appendChild(a);
              if (m.text) {
                const c = document.createElement('div');
                c.className = 'fileComment';
                c.textContent = m.text;
                bubble.appendChild(c);
              }
            }

            const rp = document.createElement('span');
            rp.className = 'replyIcon';
            rp.textContent = '‚Ü©';
            rp.onclick = e => {
              e.stopPropagation();
              replyToId = m.id;
              renderReplyPreview(m.text || (m.file ? '[—Ñ–∞–π–ª]' : ''));
            };
            bubble.appendChild(rp);
            div.appendChild(bubble);

            const md = document.createElement('div');
            md.className = 'meta';
            let label = '';
            if (m.from === userId) label = '–í—ã';
            else {
              const p = meta.participants.find(x => x.id === m.from);
              if (p) {
                if (p.role.toLowerCase() === 'manager') label = '–ú–µ–Ω–µ–¥–∂–µ—Ä';
                else if (p.role.toLowerCase() === 'client') label = '–ö–ª–∏–µ–Ω—Ç';
                else label = p.role;
              } else label = '–°–æ–±–µ—Å–µ–¥–Ω–∏–∫';
            }
            const dt = new Date(m.ts);
            const hh = String(dt.getHours()).padStart(2,'0');
            const mm = String(dt.getMinutes()).padStart(2,'0');
            md.textContent = `${label} ‚Ä¢ ${hh}:${mm}`;
            div.appendChild(md);

            msgContainer.appendChild(div);
          });

          if (wasAtBottom) {
            msgContainer.scrollTop = msgContainer.scrollHeight;
            scrollBtn.style.display = 'none';
          }
        } catch (e) {
          console.error(e);
        }
      }

      // Reply preview
      function renderReplyPreview(text) {
        let ex = document.getElementById('replyPreview');
        if (ex) ex.remove();
        if (!text) return;
        const d = document.createElement('div');
        d.id = 'replyPreview';
        d.className = 'replyPreview';
        d.textContent = `–û—Ç–≤–µ—Ç –Ω–∞: ${text}`;
        document.body.insertBefore(d, document.querySelector('.input-bar'));
      }

      // Auto-resize textarea
      function autoResize() {
        inputEl.style.height = 'auto';
        inputEl.style.height = inputEl.scrollHeight + 'px';
      }
      inputEl.addEventListener('input', () => {
        autoResize();
        sendBtn.disabled = !inputEl.value.trim();
      });

      // Send text
      sendBtn.onclick = async () => {
        const text = inputEl.value.trim();
        if (!text) return;
        sendBtn.disabled = true;
        const other = meta.participants.find(p => p.id !== userId)?.id;
        try {
          await fetch('/api/messages/send', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ chatId, from: userId, to: other, text, replyTo: replyToId })
          });
          replyToId = null;
          renderReplyPreview(null);
          inputEl.value = '';
          autoResize();
          await load();
        } catch (e) {
          console.error(e);
        } finally {
          sendBtn.disabled = !inputEl.value.trim();
        }
      };

      // Scroll button
      msgContainer.addEventListener('scroll', () => {
        const dist = msgContainer.scrollHeight - (msgContainer.scrollTop + msgContainer.clientHeight);
        scrollBtn.style.display = dist > 50 ? 'flex' : 'none';
      });
      scrollBtn.onclick = () => {
        msgContainer.scrollTop = msgContainer.scrollHeight;
        scrollBtn.style.display = 'none';
      };

      // File modal
      sendFileBtn.onclick = () => fileModalOverlay.style.display = 'flex';
      cancelFileBtn.onclick = () => fileModalOverlay.style.display = 'none';
      sendFileWithCommentBtn.onclick = async () => {
        if (!modalFileInput.files.length) return alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª');
        const file = modalFileInput.files[0];
        const comment = fileCommentInput.value.trim();
        const other = meta.participants.find(p => p.id !== userId)?.id;
        const form = new FormData();
        form.append('file', file);
        form.append('chatId', chatId);
        form.append('from', userId);
        form.append('to', other);
        if (replyToId) form.append('replyTo', replyToId);
        if (comment) form.append('text', comment);
        try {
          await fetch('/api/messages/send-file', { method:'POST', body:form });
          replyToId = null;
          renderReplyPreview(null);
          fileModalOverlay.style.display = 'none';
          await load();
        } catch (e) {
          console.error(e);
        }
      };

      // Context menu ‚ãØ
      menuBtn.onclick = e => {
        const rect = menuBtn.getBoundingClientRect();
        actionMenu.style.top = rect.bottom + 4 + 'px';
        actionMenu.style.left = rect.right - 120 + 'px';
        actionMenu.style.display = 'block';
      };
      document.addEventListener('click', e => {
        if (!actionMenu.contains(e.target) && e.target !== menuBtn) {
          actionMenu.style.display = 'none';
        }
      });

      // Add participant
      openAdd.onclick = () => {
        actionMenu.style.display = 'none';
        newParticipantInput.value = '';
        addModal.style.display = 'flex';
      };
      addParticipantCancelBtn.onclick = () => addModal.style.display = 'none';
      addParticipantConfirmBtn.onclick = async () => {
        const val = newParticipantInput.value.trim();
        if (!val) return alert('–í–≤–µ–¥–∏—Ç–µ ID –∏ —Ä–æ–ª—å');
        const [uid, ...roleArr] = val.split(' ');
        try {
          const res = await fetch('/api/add-to-chat', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ chatId, userId: uid, role: roleArr.join(' ') })
          });
          if (!res.ok) throw '';
          addModal.style.display = 'none';
          await load();
        } catch {
          alert('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è');
        }
      };

      // Remove participant
      openRemove.onclick = () => {
        actionMenu.style.display = 'none';
        removeList.innerHTML = '';
        meta.participants.slice(2).forEach(p => {
          const div = document.createElement('div');
          div.className = 'remove-item';
          div.innerHTML = `
            <span>${p.id} (${p.role})</span>
            <button data-id="${p.id}" class="remove-btn">–£–¥–∞–ª–∏—Ç—å</button>
          `;
          removeList.appendChild(div);
        });
        removeModal.style.display = 'flex';
      };
      closeRemoveBtn.onclick = () => removeModal.style.display = 'none';
      removeList.onclick = async e => {
        if (!e.target.classList.contains('remove-btn')) return;
        const uid = e.target.dataset.id;
        try {
          const res = await fetch('/api/remove-from-chat', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ chatId, userId: uid })
          });
          if (!res.ok) throw '';
          removeModal.style.display = 'none';
          await load();
        } catch {
          alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
        }
      };

      // Initial load & polling
      await load();
      setInterval(load, 5000);
    })();
  </script>
</body>
</html>
