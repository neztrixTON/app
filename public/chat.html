<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport"
        content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
  <title>–ß–∞—Ç</title>
  <link rel="stylesheet" href="css/style.css"/>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <header>
    <span id="backBtn" class="back-btn">&#8592;</span>
    <div class="header-info">
      <div id="chatTitle">–ß–∞—Ç</div>
      <div id="status">–æ—Ñ–ª–∞–π–Ω</div>
    </div>
    <button id="detailsBtn" class="header-btn">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</button>
    <button id="menuBtn" class="header-btn">‚ãØ</button>
  </header>

  <div class="messages" id="messagesContainer"></div>
  <button id="scrollToBottomBtn" class="scroll-btn">‚¨áÔ∏é</button>

  <!-- –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –¥–µ–π—Å—Ç–≤–∏–π -->
  <ul id="actionMenu" class="action-menu">
    <li id="openAdd">–î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞</li>
    <li id="openRemove">–£–¥–∞–ª–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞</li>
  </ul>

  <!-- –ú–æ–¥–∞–ª–∫–∞ ¬´–ü–æ–¥—Ä–æ–±–Ω–µ–µ¬ª -->
  <div id="detailsModal" class="modal-overlay">
    <div class="modal modal-centered">
      <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ –∑–∞—è–≤–∫–µ</h3>
      <pre id="detailsText" class="details-text"></pre>
      <button id="closeDetailsBtn" class="cancel-btn">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ ¬´–î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞¬ª -->
  <div id="addModal" class="modal-overlay">
    <div class="modal modal-centered">
      <h3>–î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞</h3>
      <input type="text" id="newParticipantInput" placeholder="ID –∏ —Ä–æ–ª—å, –Ω–∞–ø—Ä. 123456 –ú–∞—Å—Ç–µ—Ä"/>
      <button id="addParticipantConfirmBtn">–î–æ–±–∞–≤–∏—Ç—å</button>
      <button id="addParticipantCancelBtn" class="cancel-btn">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ ¬´–£–¥–∞–ª–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞¬ª -->
  <div id="removeModal" class="modal-overlay">
    <div class="modal modal-centered">
      <h3>–£–¥–∞–ª–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞</h3>
      <div id="removeList" class="remove-list"></div>
      <button id="closeRemoveBtn" class="cancel-btn">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ ¬´–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–∞–π–ª¬ª -->
  <div id="fileModalOverlay" class="modal-overlay">
    <div class="modal modal-centered">
      <h3>–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–∞–π–ª</h3>
      <input type="file" id="modalFileInput"/>
      <textarea id="fileComment" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"></textarea>
      <button id="sendFileWithCommentBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      <button id="cancelFileBtn" class="cancel-btn">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>

  <!-- –ü–∞–Ω–µ–ª—å –≤–≤–æ–¥–∞ -->
  <div class="input-bar">
    <textarea id="messageInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." rows="1"></textarea>
    <button id="sendBtn" disabled>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    <button id="sendFileBtn">üìé</button>
  </div>

  <script>
    Telegram.WebApp.ready();
    (async function(){
      const params = new URLSearchParams(location.search);
      const chatId = params.get('chatId');
      const user = Telegram.WebApp.initDataUnsafe?.user;
      if(!user||!chatId){
        document.getElementById('messagesContainer').innerHTML =
          '<p class="error">–ù–µ–≤–µ—Ä–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã.</p>';
        return;
      }
      const userId = String(user.id);

      // ===== DOM =====
      const backBtn                 = document.getElementById('backBtn');
      const chatTitleEl             = document.getElementById('chatTitle');
      const statusEl                = document.getElementById('status');
      const detailsBtn              = document.getElementById('detailsBtn');
      const menuBtn                 = document.getElementById('menuBtn');
      const actionMenu              = document.getElementById('actionMenu');
      const openAdd                 = document.getElementById('openAdd');
      const openRemove              = document.getElementById('openRemove');
      const detailsModal            = document.getElementById('detailsModal');
      const detailsText             = document.getElementById('detailsText');
      const closeDetailsBtn         = document.getElementById('closeDetailsBtn');
      const addModal                = document.getElementById('addModal');
      const newParticipantInput     = document.getElementById('newParticipantInput');
      const addParticipantConfirmBtn= document.getElementById('addParticipantConfirmBtn');
      const addParticipantCancelBtn = document.getElementById('addParticipantCancelBtn');
      const removeModal             = document.getElementById('removeModal');
      const removeList              = document.getElementById('removeList');
      const closeRemoveBtn          = document.getElementById('closeRemoveBtn');
      const fileModalOverlay        = document.getElementById('fileModalOverlay');
      const modalFileInput          = document.getElementById('modalFileInput');
      const fileCommentInput        = document.getElementById('fileComment');
      const sendFileWithCommentBtn  = document.getElementById('sendFileWithCommentBtn');
      const cancelFileBtn           = document.getElementById('cancelFileBtn');
      const msgContainer            = document.getElementById('messagesContainer');
      const scrollBtn               = document.getElementById('scrollToBottomBtn');
      const inputEl                 = document.getElementById('messageInput');
      const sendBtn                 = document.getElementById('sendBtn');
      const sendFileBtn             = document.getElementById('sendFileBtn');

      let meta = { participants: [], isAdmin: false, requestId:'', type:'', address:'', createdAt:'' };
      let replyToId = null;

      backBtn.onclick = ()=> location.href='index.html';

      // ===== –§—É–Ω–∫—Ü–∏—è 1: Load + —Ä–µ–Ω–¥–µ—Ä =====
      async function loadMessages(){
        const res = await fetch(`/api/messages?chatId=${chatId}&userId=${userId}`);
        if(!res.ok) return;
        const { messages, meta: m } = await res.json();
        meta = m;

        // –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å –º–µ–Ω—é ‚ãØ —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∞
        menuBtn.style.display = meta.isAdmin ? 'inline-block' : 'none';

        // –∑–∞–≥–æ–ª–æ–≤–æ–∫
        chatTitleEl.textContent = `–ß–∞—Ç –ø–æ –∑–∞—è–≤–∫–µ #${meta.requestId||'?'}`;

        // —Å—Ç–∞—Ç—É—Å ¬´–æ–Ω–ª–∞–π–Ω¬ª
        const other = meta.participants.find(p=>p.id!==userId)?.id;
        if(other){
          const st = await fetch(`/api/status?userId=${other}`).then(r=>r.json());
          statusEl.textContent = st.online?'–æ–Ω–ª–∞–π–Ω':'–æ—Ñ–ª–∞–π–Ω';
          statusEl.style.color = st.online?'#7CFC00':'#888';
        }

        // —Ä–µ–Ω–¥–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π
        const atBottom = (msgContainer.scrollTop+msgContainer.clientHeight) >= (msgContainer.scrollHeight-20);
        msgContainer.innerHTML = '';
        messages.forEach(m=>{
          const div = document.createElement('div');
          div.className = 'message '+(m.from===userId?'me':'you');

          // –æ—Ç–≤–µ—Ç
          if(m.replyTo){
            const rp = messages.find(x=>x.id===m.replyTo);
            if(rp){
              const rv=document.createElement('div');
              rv.className='replyTo';
              rv.textContent=rp.text||'[—Ñ–∞–π–ª]';
              div.appendChild(rv);
            }
          }

          // –ø—É–∑—ã—Ä—ë–∫
          const bubble = document.createElement('div');
          bubble.className='bubble';
          if(m.text && !m.file) bubble.textContent=m.text;
          if(m.file){
            const a = document.createElement('a');
            a.href=m.file; a.textContent='üìé –§–∞–π–ª'; a.target='_blank'; a.className='fileLink';
            bubble.appendChild(a);
            if(m.text){
              const cm=document.createElement('div');
              cm.className='fileComment'; cm.textContent=m.text;
              bubble.appendChild(cm);
            }
          }

          // –∏–∫–æ–Ω–∫–∞ –æ—Ç–≤–µ—Ç–∞
          const ico=document.createElement('span');
          ico.className='replyIcon'; ico.textContent='‚Ü©';
          ico.onclick=e=>{
            e.stopPropagation();
            replyToId=m.id;
            renderReplyPreview(m.text|| (m.file?'[—Ñ–∞–π–ª]':''));
          };
          bubble.appendChild(ico);
          div.appendChild(bubble);

          // –º–µ—Ç–∞
          const md=document.createElement('div');
          md.className='meta';
          let label='–°–æ–±–µ—Å–µ–¥–Ω–∏–∫';
          if(m.from===userId) label='–í—ã';
          else{
            const p=meta.participants.find(x=>x.id===m.from);
            if(p){
              const rl=p.role.toLowerCase();
              if(rl==='manager') label='–ú–µ–Ω–µ–¥–∂–µ—Ä';
              else if(rl==='client') label='–ö–ª–∏–µ–Ω—Ç';
              else label=p.role;
            }
          }
          const dt=new Date(m.ts), hh=String(dt.getHours()).padStart(2,'0'), mm=String(dt.getMinutes()).padStart(2,'0');
          md.textContent=`${label} ‚Ä¢ ${hh}:${mm}`;
          div.appendChild(md);

          msgContainer.appendChild(div);
        });
        if(atBottom){
          msgContainer.scrollTop=msgContainer.scrollHeight;
          scrollBtn.style.display='none';
        }
      }

      // ===== –§—É–Ω–∫—Ü–∏—è 2: –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –æ—Ç–≤–µ—Ç–∞ =====
      function renderReplyPreview(text){
        const ex=document.getElementById('replyPreview');
        if(ex) ex.remove();
        if(!text) return;
        const d=document.createElement('div');
        d.id='replyPreview'; d.className='replyPreview';
        d.textContent=`–û—Ç–≤–µ—Ç –Ω–∞: ${text}`;
        document.body.insertBefore(d, document.querySelector('.input-bar'));
      }

      // ===== –§—É–Ω–∫—Ü–∏—è 3: –∞–≤—Ç–æ‚Äëresize textarea =====
      inputEl.addEventListener('input', ()=>{
        inputEl.style.height='auto';
        inputEl.style.height=inputEl.scrollHeight+'px';
        sendBtn.disabled = !inputEl.value.trim();
      });

      // ===== –§—É–Ω–∫—Ü–∏—è 4: –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ–∫—Å—Ç–∞ =====
      sendBtn.onclick=async()=>{
        const txt=inputEl.value.trim();
        if(!txt) return;
        const other=meta.participants.find(p=>p.id!==userId)?.id;
        await fetch('/api/messages/send',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({chatId,from:userId,to:other,text:txt,replyTo:replyToId})
        });
        replyToId=null; renderReplyPreview(null);
        inputEl.value=''; inputEl.style.height='auto';
        await loadMessages();
      };

      // ===== –§—É–Ω–∫—Ü–∏—è 5: –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–∞–π–ª–∞ =====
      sendFileBtn.onclick=()=>fileModalOverlay.style.display='flex';
      cancelFileBtn.onclick=()=>fileModalOverlay.style.display='none';
      sendFileWithCommentBtn.onclick=async()=>{
        if(!modalFileInput.files.length) return alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª');
        const f=modalFileInput.files[0], cm=fileCommentInput.value.trim();
        const other=meta.participants.find(p=>p.id!==userId)?.id;
        const form=new FormData();
        form.append('file',f); form.append('chatId',chatId);
        form.append('from',userId); form.append('to',other);
        if(replyToId) form.append('replyTo',replyToId);
        if(cm) form.append('text',cm);
        await fetch('/api/messages/send-file',{method:'POST',body:form});
        replyToId=null; renderReplyPreview(null);
        fileModalOverlay.style.display='none';
        await loadMessages();
      };

      // ===== –§—É–Ω–∫—Ü–∏—è 6: –∫–Ω–æ–ø–∫–∞ ¬´–ü–æ–¥—Ä–æ–±–Ω–µ–µ¬ª =====
      detailsBtn.onclick=()=>{
        detailsText.textContent=
          `–ó–∞—è–≤–∫–∞ #${meta.requestId}\n–¢–∏–ø: ${meta.type}\n–ê–¥—Ä–µ—Å: ${meta.address}\n–î–∞—Ç–∞: ${meta.createdAt}`;
        detailsModal.style.display='flex';
      };
      closeDetailsBtn.onclick=()=>detailsModal.style.display='none';

      // ===== –§—É–Ω–∫—Ü–∏—è 7: –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é ‚ãØ =====
      menuBtn.onclick=e=>{
        if(!meta.isAdmin) return;
        const r=menuBtn.getBoundingClientRect();
        actionMenu.style.top=`${r.bottom+4}px`;
        actionMenu.style.left=`${r.right-120}px`;
        actionMenu.style.display='block';
      };
      document.addEventListener('click',e=>{
        if(!actionMenu.contains(e.target)&&e.target!==menuBtn){
          actionMenu.style.display='none';
        }
      });

      // ===== –§—É–Ω–∫—Ü–∏—è 8a: –¥–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞ =====
      openAdd.onclick=()=>{
        actionMenu.style.display='none';
        newParticipantInput.value='';
        addModal.style.display='flex';
      };
      addParticipantCancelBtn.onclick=()=>addModal.style.display='none';
      addParticipantConfirmBtn.onclick=async()=>{
        const v=newParticipantInput.value.trim();
        if(!v) return alert('–í–≤–µ–¥–∏—Ç–µ ID –∏ —Ä–æ–ª—å');
        const [uid,...role]=v.split(' ');
        await fetch('/api/add-to-chat',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({chatId,userId:uid,role:role.join(' ')})
        });
        addModal.style.display='none';
        await loadMessages();
      };

      // ===== –§—É–Ω–∫—Ü–∏—è 8b: —É–¥–∞–ª–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞ =====
      openRemove.onclick=()=>{
        actionMenu.style.display='none';
        removeList.innerHTML='';
        meta.participants.slice(2).forEach(p=>{
          const div=document.createElement('div');
          div.className='remove-item';
          div.innerHTML=`
            <span>${p.id} (${p.role})</span>
            <button data-id="${p.id}" class="remove-btn">–£–¥–∞–ª–∏—Ç—å</button>
          `;
          removeList.appendChild(div);
        });
        removeModal.style.display='flex';
      };
      closeRemoveBtn.onclick=()=>removeModal.style.display='none';
      removeList.onclick=async e=>{
        if(!e.target.classList.contains('remove-btn')) return;
        const uid=e.target.dataset.id;
        await fetch('/api/remove-from-chat',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({chatId,userId:uid})
        });
        removeModal.style.display='none';
        await loadMessages();
      };

      // ===== —Å–∫—Ä–æ–ª–ª ¬´‚¨áÔ∏é¬ª =====
      msgContainer.onscroll=()=>{
        const d=msgContainer.scrollHeight-(msgContainer.scrollTop+msgContainer.clientHeight);
        scrollBtn.style.display=d>50?'flex':'none';
      };
      scrollBtn.onclick=()=>{
        msgContainer.scrollTop=msgContainer.scrollHeight;
        scrollBtn.style.display='none';
      };

      // ===== —Å—Ç–∞—Ä—Ç =====
      await loadMessages();
      setInterval(loadMessages,1000);
    })();
  </script>
</body>
</html>
