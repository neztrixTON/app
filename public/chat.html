<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Чат</title>
  <link rel="stylesheet" href="css/style.css" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <header>
    <span id="backBtn">&#8592;</span>
    <div>
      <div id="chatTitle">Чат</div>
      <div id="status" style="color:#888;">офлайн</div>
    </div>
  </header>

  <div class="messages" id="messagesContainer">
    <!-- Здесь появятся сообщения -->
  </div>

  <div class="input-bar">
    <input type="text" id="messageInput" placeholder="Сообщение..." autocomplete="off" />
    <button id="sendBtn" disabled>Отправить</button>
  </div>

  <script>
    Telegram.WebApp.ready();

    (function() {
      const params = new URLSearchParams(window.location.search);
      const chatId = params.get('chatId');
      const user = Telegram.WebApp.initDataUnsafe?.user;
      if (!user || !chatId) {
        document.getElementById('messagesContainer').innerHTML =
          '<p style="padding:12px;">Неверные параметры.</p>';
        return;
      }
      const userId = String(user.id);

      // Определяем “другого” в chatId
      const [u1, u2] = chatId.split('_');
      const other = (u1 === userId ? u2 : u1);

      const chatTitleEl = document.getElementById('chatTitle');
      const statusEl    = document.getElementById('status');
      const backBtn     = document.getElementById('backBtn');
      const msgContainer= document.getElementById('messagesContainer');
      const inputEl     = document.getElementById('messageInput');
      const sendBtn     = document.getElementById('sendBtn');

      chatTitleEl.textContent = `Чат с ${other}`;

      // Кнопка “назад”
      backBtn.onclick = () => {
        window.location.href = 'index.html';
      };

      // Обновление статуса собеседника раз в 5 сек
      async function updateStatus() {
        try {
          const res = await fetch(`/api/status?userId=${encodeURIComponent(other)}`);
          if (!res.ok) throw new Error();
          const data = await res.json();
          statusEl.textContent = data.online ? 'онлайн' : 'офлайн';
          statusEl.style.color   = data.online ? '#0f0' : '#888';
        } catch(e) {
          console.error('Не удалось получить статус:', e);
        }
      }
      updateStatus();
      setInterval(updateStatus, 5000);

      // Загрузка и рендер сообщений
      async function loadMessages() {
        try {
          const res = await fetch(
            `/api/messages?chatId=${encodeURIComponent(chatId)}&userId=${encodeURIComponent(userId)}`
          );
          if (!res.ok) throw new Error('Не удалось загрузить сообщения');
          const msgs = await res.json();
          msgContainer.innerHTML = '';

          msgs.forEach(m => {
            const div = document.createElement('div');
            div.classList.add('message', (m.from === userId ? 'me' : 'you'));

            const bubble = document.createElement('div');
            bubble.classList.add('bubble');
            bubble.textContent = m.text;

            const meta = document.createElement('div');
            meta.classList.add('meta');
            const date = new Date(m.ts);
            const hh = String(date.getHours()).padStart(2, '0');
            const mm = String(date.getMinutes()).padStart(2, '0');
            meta.textContent = (m.from === userId ? 'Вы' : 'Собеседник') + ` • ${hh}:${mm}`;

            div.appendChild(bubble);
            div.appendChild(meta);
            msgContainer.appendChild(div);
          });

          // Прокрутка вниз
          msgContainer.scrollTop = msgContainer.scrollHeight;
        } catch (err) {
          console.error(err);
        }
      }

      // Обновляем каждые 1 сек
      loadMessages();
      setInterval(loadMessages, 1000);

      // Отправка сообщения
      inputEl.addEventListener('input', () => {
        sendBtn.disabled = inputEl.value.trim() === '';
      });

      sendBtn.addEventListener('click', async () => {
        const text = inputEl.value.trim();
        if (!text) return;
        sendBtn.disabled = true;
        try {
          const res = await fetch('/api/messages/send', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              chatId,
              from: userId,
              to: other,
              text
            })
          });
          if (!res.ok) throw new Error('Не удалось отправить сообщение');
          inputEl.value = '';
          await loadMessages();
        } catch (err) {
          alert('Ошибка: ' + err.message);
          console.error(err);
        } finally {
          sendBtn.disabled = inputEl.value.trim() === '';
        }
      });
    })();
  </script>
</body>
</html>
