<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta 
    name="viewport" 
    content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"
  >
  <title>Чат</title>
  <link rel="stylesheet" href="css/style.css">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <header class="header">
    <button id="backBtn" class="header__back">&larr;</button>
    <div class="header__info">
      <h2 id="chatTitle" class="header__title">Чат</h2>
      <span id="chatRole" class="header__role"></span>
    </div>
    <button id="addMasterBtn" class="header__add-master">Добавить мастера</button>
  </header>

  <div class="messages" id="messagesContainer"></div>

  <div class="input-bar">
    <textarea id="messageInput" class="input-bar__textarea" placeholder="Введите сообщение..." rows="1"></textarea>
    <button id="sendBtn" class="input-bar__send" disabled>Отправить</button>
  </div>

  <!-- Модалка добавления мастера -->
  <div id="modalMaster" class="modal">
    <div class="modal__content">
      <h3 class="modal__title">Добавить мастера</h3>
      <input id="masterIdInput" class="modal__input" placeholder="ID мастера" />
      <button id="doAddMaster" class="btn modal__btn">Добавить</button>
      <button id="cancelAddMaster" class="btn modal__btn modal__btn--cancel">Отмена</button>
    </div>
  </div>

  <script>
    Telegram.WebApp.ready();

    const params = new URLSearchParams(window.location.search);
    const chatId = params.get('chatId');
    const user = Telegram.WebApp.initDataUnsafe.user;
    if (!chatId || !user) {
      document.body.innerHTML = '<p class="center">Неверные параметры!</p>';
      throw new Error('No chatId or user');
    }

    const titleEl       = document.getElementById('chatTitle');
    const roleEl        = document.getElementById('chatRole');
    const backBtn       = document.getElementById('backBtn');
    const addMasterBtn  = document.getElementById('addMasterBtn');
    const msgsContainer = document.getElementById('messagesContainer');
    const inp           = document.getElementById('messageInput');
    const sendBtn       = document.getElementById('sendBtn');

    const modal        = document.getElementById('modalMaster');
    const masterInput  = document.getElementById('masterIdInput');
    const doAddMaster  = document.getElementById('doAddMaster');
    const cancelAdd    = document.getElementById('cancelAddMaster');

    let myRole = null;

    backBtn.onclick = () => Telegram.WebApp.close();

    // Загрузка роли и мета
    (async function init() {
      try {
        const res = await fetch(`/api/chats?userId=${user.id}`);
        const list = await res.json();
        const chat = list.find(c => c.chatId === chatId);
        if (!chat) throw new Error('Chat not in your list');
        titleEl.textContent = chat.title;
        roleEl.textContent  = `(${chat.role})`;
        myRole = chat.role;
        if (myRole !== 'manager') {
          addMasterBtn.style.display = 'none';
        }
        loadMessages();
        setInterval(loadMessages, 1000);
      } catch (e) {
        console.error(e);
        msgsContainer.innerHTML = '<p class="center">Ошибка инициализации чата</p>';
      }
    })();

    // Авто-рост textarea
    inp.addEventListener('input', () => {
      inp.style.height = 'auto';
      inp.style.height = inp.scrollHeight + 'px';
      sendBtn.disabled = inp.value.trim() === '';
    });

    sendBtn.onclick = async () => {
      const text = inp.value.trim();
      if (!text) return;
      sendBtn.disabled = true;
      await fetch('/api/messages/send', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({
          chatId, from: user.id, to: null, text
        })
      });
      inp.value = '';
      sendBtn.disabled = true;
      loadMessages();
    };

    async function loadMessages() {
      try {
        const res = await fetch(`/api/messages?chatId=${chatId}&userId=${user.id}`);
        const msgs = await res.json();
        msgsContainer.innerHTML = '';
        msgs.forEach(m => {
          const div = document.createElement('div');
          div.className = 'message ' + (m.from == user.id ? 'me' : 'you');
          // replyTo
          if (m.replyTo) {
            const rep = msgs.find(x => x.id === m.replyTo);
            if (rep) {
              const rdiv = document.createElement('div');
              rdiv.className = 'message__reply';
              rdiv.textContent = (rep.text || '[файл]').slice(0, 50);
              div.appendChild(rdiv);
            }
          }
          const bubble = document.createElement('div');
          bubble.className = 'message__bubble';
          bubble.textContent = m.text || '';
          div.appendChild(bubble);
          const meta = document.createElement('div');
          meta.className = 'message__meta';
          const date = new Date(m.ts);
          meta.textContent = `${m.from==user.id?'Вы':'Собеседник'} • ${date.getHours()}:${String(date.getMinutes()).padStart(2,'0')}`;
          div.appendChild(meta);
          msgsContainer.appendChild(div);
        });
        msgsContainer.scrollTop = msgsContainer.scrollHeight;
      } catch (e) {
        console.error(e);
      }
    }

    // Добавление мастера
    addMasterBtn.onclick = () => modal.classList.add('modal--open');
    cancelAdd.onclick = () => modal.classList.remove('modal--open');
    doAddMaster.onclick = async () => {
      const mid = masterInput.value.trim();
      if (!mid) return;
      await fetch(`/api/chat/${chatId}/add-master`, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ managerId: user.id, masterId: mid })
      });
      modal.classList.remove('modal--open');
      masterInput.value = '';
      alert('Мастер добавлен');
    };
  </script>
</body>
</html>
